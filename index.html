<!DOCTYPE html>
<html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>CRM de Llamadas — v7.5</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
header{position:sticky;top:0;z-index:50}
.card{border-radius:1rem;box-shadow:0 8px 20px rgba(0,0,0,.06)}
.navbtn{padding:.4rem .8rem;border-radius:.6rem;background:#eef2f7}
.navbtn.active{background:#111827;color:#fff}
#map{min-height:420px}
</style>
</head>
<body class="bg-gray-100 text-gray-900">
<header class="bg-white shadow p-3">
  <div class="max-w-7xl mx-auto flex items-center justify-between">
    <div class="flex items-center space-x-3">
      <img src="data:image/png;base64,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" class="h-7 w-auto" alt="Logo">
      <h1 class="font-bold text-lg">CRM de Llamadas</h1>
      <span class="text-xs px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded-full">v7.5</span>
    </div>
    <nav class="flex gap-2">
      <button class="navbtn active" data-view="mapa"><i class="fa fa-map"></i> Mapa</button>
      <button class="navbtn" data-view="llamada"><i class="fa fa-phone"></i> Registrar llamada</button>
      <button class="navbtn" data-view="asignar"><i class="fa fa-calendar-week"></i> Asignar semana/día</button>
      <button class="navbtn" data-view="reporte"><i class="fa fa-chart-column"></i> Reporte</button>
    </nav>
  </div>
</header>

<section id="loginSection" class="max-w-md mx-auto mt-10 bg-white p-6 card">
  <h2 class="font-semibold text-lg mb-4"><i class="fa fa-lock"></i> Acceso</h2>
  <form id="loginForm" class="space-y-3">
    <div>
      <label class="block text-sm">Usuario</label>
      <input id="loginUser" class="w-full p-2 border rounded" autocomplete="username" required>
    </div>
    <div>
      <label class="block text-sm">Contraseña</label>
      <input id="loginPass" type="password" class="w-full p-2 border rounded" autocomplete="current-password" required>
    </div>
    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Entrar</button>
    <p class="text-xs text-gray-500">Se valida contra la hoja <em>Usuarios</em> publicada.</p>
  </form>
  <div id="loginError" class="mt-3 text-sm text-red-600 hidden"></div>
</section>

<main id="appSection" class="hidden max-w-7xl mx-auto mt-6 px-4">
  <div class="bg-white p-4 card mb-4">
    <div class="flex flex-wrap gap-2 items-center">
      <button id="btnRegistrarLlamada" class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"><i class="fa fa-phone"></i> Registrar llamada</button>
      <button id="btnAsignarSemana" class="px-3 py-1.5 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm"><i class="fa fa-calendar-week"></i> Asignar semana/día</button>
      <button id="btnRefrescar" class="px-3 py-1.5 bg-gray-200 rounded hover:bg-gray-300 text-sm"><i class="fa fa-rotate"></i> Refrescar</button>
      <button id="btnExport" class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-sm"><i class="fa fa-file-export"></i> Exportar CSV</button>
    </div>
  </div>

  <div class="bg-white p-4 card mb-6">
    <h3 class="font-semibold text-lg mb-2">Mapa de clientes</h3>
    <div id="map" class="w-full h-96 rounded"></div>
  </div>

  <div class="bg-white p-4 card mb-10">
    <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
      <div><label class="block text-sm">Semana</label><select id="fSemana" class="w-full p-2 border rounded"></select></div>
      <div><label class="block text-sm">Día</label><select id="fDia" class="w-full p-2 border rounded"></select></div>
      <div><label class="block text-sm">Vendedor</label><select id="fVendedor" class="w-full p-2 border rounded"></select></div>
      <div><label class="block text-sm">gestor_servicio</label><select id="fGestor" class="w-full p-2 border rounded"></select></div>
      <div><label class="block text-sm">Empresa</label><select id="fEmpresa" class="w-full p-2 border rounded"></select></div>
      <div><label class="block text-sm">Buscar</label><input id="fSearch" class="w-full p-2 border rounded" placeholder="Nombre o Cod Empresa"></div>
    </div>
    <div class="mt-5 overflow-x-auto">
      <table id="tablaClientes" class="min-w-full text-sm text-left text-gray-700 border">
        <thead class="bg-gray-50 text-xs uppercase">
          <tr>
            <th class="px-4 py-2">Cod Empresa</th>
            <th class="px-4 py-2">Cliente</th>
            <th class="px-4 py-2">Semana</th>
            <th class="px-4 py-2">Día</th>
            <th class="px-4 py-2">Vendedor</th>
            <th class="px-4 py-2">gestor_servicio</th>
            <th class="px-4 py-2">Empresa</th>
            <th class="px-4 py-2">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Llamada -->
  <section data-view="llamada" class="hidden">
    <div class="bg-white p-6 card">
      <h3 class="font-semibold text-lg mb-3"><i class="fa fa-phone"></i> Registrar llamada</h3>
      <form id="formLlamada" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><label class="block text-sm">Cliente</label><input list="dl_clientes" id="ll_cliente" class="w-full p-2 border rounded"><datalist id="dl_clientes"></datalist></div>
        <div><label class="block text-sm">Cod Empresa</label><input id="ll_cod" class="w-full p-2 border rounded" readonly></div>
        <div><label class="block text-sm">Vendedor</label><input id="ll_vendedor" class="w-full p-2 border rounded" readonly></div>
        <div><label class="block text-sm">gestor_servicio</label><input id="ll_gestor" class="w-full p-2 border rounded" readonly></div>
        <div><label class="block text-sm">Fecha y hora</label><input id="ll_fecha" class="w-full p-2 border rounded" readonly></div>
        <div><label class="block text-sm">Resultado</label><select id="ll_resultado" class="w-full p-2 border rounded"><option>Exitosa</option><option>Pendiente</option><option>No contesta</option><option>Cliente no disponible</option></select></div>
        <div class="md:col-span-2 flex justify-end gap-2">
          <button type="button" id="ll_cancel" class="px-3 py-1.5 bg-gray-200 rounded hover:bg-gray-300">Cancelar</button>
          <button class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700">Guardar</button>
        </div>
      </form>
    </div>
  </section>

  <!-- Asignar -->
  <section data-view="asignar" class="hidden">
    <div class="bg-white p-6 card">
      <h3 class="font-semibold text-lg mb-3"><i class="fa fa-calendar-week"></i> Asignar semana/día</h3>
      <form id="formAsignar" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="md:col-span-2"><label class="block text-sm">Cliente</label><input list="dl_clientes2" id="asig_cliente" class="w-full p-2 border rounded"><datalist id="dl_clientes2"></datalist></div>
        <div><label class="block text-sm">Semana</label><input id="asig_semana" type="number" min="1" max="53" class="w-full p-2 border rounded"></div>
        <div><label class="block text-sm">Día</label><select id="asig_dia" class="w-full p-2 border rounded"><option>Lunes</option><option>Martes</option><option>Miércoles</option><option>Jueves</option><option>Viernes</option><option>Sábado</option><option>Domingo</option></select></div>
        <div class="md:col-span-2 flex justify-end gap-2">
          <button type="button" id="asig_cancel" class="px-3 py-1.5 bg-gray-200 rounded hover:bg-gray-300">Cancelar</button>
          <button class="px-3 py-1.5 bg-yellow-600 text-white rounded hover:bg-yellow-700">Aplicar</button>
        </div>
      </form>
    </div>
  </section>

  <!-- Reporte -->
  <section data-view="reporte" class="hidden">
    <div class="bg-white p-6 card">
      <h3 class="font-semibold text-lg mb-3"><i class="fa fa-chart-column"></i> Reporte</h3>
      <p class="text-sm text-gray-600">Próximo: conexión a Google Sheets para consolidar llamadas.</p>
    </div>
  </section>
</main>

<script>
const URLS = {
  clientes: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1016315198&single=true&output=csv",
  calendario: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv",
  usuarios: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv"
};
const KEY = "Cod Empresa";
const norm = s => (s??"").toString().replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim().toLowerCase();
const esc = s => s==null? "": String(s);

let DATA = { usuarios:[], clientes:[], calendario:[], joined:[] };
let map, markers=[];

// --------- LOGIN (solo lee Usuarios) ----------
document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const username = norm(document.getElementById('loginUser').value);
  const pass = document.getElementById('loginPass').value;
  const err = document.getElementById('loginError');
  err.classList.add('hidden'); err.textContent="";
  try{
    // Siempre leo la hoja Usuarios en cada intento
    DATA.usuarios = await loadCSV(URLS.usuarios);
    const row = DATA.usuarios.find(r => norm(r['Usuario']||r['Login']||r['gestor_servicio']) === username);
    if(!row) throw new Error('Usuario no encontrado');
    const clave = (row['Contrasena']||row['Contraseña']||row['Password']||'').toString();
    if(clave && clave !== pass) throw new Error('Contraseña inválida');
    // Éxito → mostrar app, luego cargar data pesada
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('appSection').classList.remove('hidden');
    // no limpiamos campos
    await loadClientesCalendario();
    buildJoined();
    renderFilters();
    renderMap(); renderTable(); fillDatalists();
  }catch(ex){
    err.textContent = "⚠️ " + ex.message;
    err.classList.remove('hidden');
  }
});

// --------- CARGA CSV ---------
function loadCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{header:true,download:true,skipEmptyLines:true,
      complete: res => resolve(res.data.map(r=>{const o={}; for(const k in r){o[k]=r[k]; o[k.trim()]=r[k];} return o;})),
      error: err => reject(err)
    });
  });
}
async function loadClientesCalendario(){
  const [c, cal] = await Promise.all([ loadCSV(URLS.clientes), loadCSV(URLS.calendario) ]);
  DATA.clientes = c; DATA.calendario = cal;
}
// --------- JOIN ---------
function getSemana(r){ return r['Semana']||r['SEMANA']||r['NumSemana']||r['Sem']||r['semana']; }
function getDia(r){ return r['Dia']||r['Día']||r['DIA']||r['dia']||r['Día de visita']||r['Dia_visita']||r['Dia semana']||r['DOW']; }

function buildJoined(){
  const idx = {};
  DATA.calendario.forEach(r=>{ const k = norm(r[KEY]); if(k) idx[k]=r;});
  DATA.joined = DATA.clientes.map(c=>{
    const k = norm(c[KEY]);
    const m = idx[k];
    return {
      cod: c[KEY]||'',
      nombre: c['NombreCliente']||c['Cliente']||c['RazonSocial']||'',
      lat: parseFloat(c['Latitud']||c['LATITUD']||c['latitud']||''),
      lon: parseFloat(c['Longitud']||c['LONGITUD']||c['longitud']||''),
      semana: m ? (getSemana(m)||'Por asignar') : 'Por asignar',
      dia: m ? (getDia(m)||'Por asignar') : 'Por asignar',
      vendedor: c['Vendedor']||c['VENDEDOR']||'',
      gestor: c['gestor_servicio']||c['GESTOR_SERVICIO']||c['Gestor']||'',
      empresa: c['Empresa']||c['EMPRESA']||''
    };
  });
}

// --------- FILTROS ---------
function uniq(a){ return Array.from(new Set(a.filter(Boolean))).sort((x,y)=> String(x).localeCompare(String(y))); }
function setOpts(sel, arr){ sel.innerHTML=''; arr.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent= v===''?'Todos':v; sel.appendChild(o); }); }
function renderFilters(){
  setOpts(document.getElementById('fSemana'), ['','Por asignar', ...uniq(DATA.joined.map(r=>r.semana).filter(v=>v!=='Por asignar'))]);
  setOpts(document.getElementById('fDia'), ['','Por asignar', ...uniq(DATA.joined.map(r=>r.dia).filter(v=>v && v!=='Por asignar'))]);
  setOpts(document.getElementById('fVendedor'), [''].concat(uniq(DATA.joined.map(r=>r.vendedor))));
  setOpts(document.getElementById('fGestor'), [''].concat(uniq(DATA.joined.map(r=>r.gestor))));
  setOpts(document.getElementById('fEmpresa'), [''].concat(uniq(DATA.joined.map(r=>r.empresa))));
  ['fSemana','fDia','fVendedor','fGestor','fEmpresa'].forEach(id=> document.getElementById(id).addEventListener('change', ()=>{renderMap();renderTable();}));
  document.getElementById('fSearch').addEventListener('input', ()=>{renderMap();renderTable();});
}

function getFiltered(){
  const fS = document.getElementById('fSemana').value;
  const fD = document.getElementById('fDia').value.toLowerCase();
  const fV = document.getElementById('fVendedor').value;
  const fG = document.getElementById('fGestor').value;
  const fE = document.getElementById('fEmpresa').value;
  const q = document.getElementById('fSearch').value.trim().toLowerCase();
  return DATA.joined.filter(r=>{
    const okS = !fS || String(r.semana)===fS;
    const okD = !fD || String(r.dia).toLowerCase()===fD;
    const okV = !fV || r.vendedor===fV;
    const okG = !fG || r.gestor===fG;
    const okE = !fE || r.empresa===fE;
    const okQ = !q || norm(r.cod).includes(q) || norm(r.nombre).includes(q);
    return okS && okD && okV && okG && okE && okQ;
  });
}

// --------- TABLA ---------
function renderTable(){
  const tbody = document.querySelector('#tablaClientes tbody'); tbody.innerHTML='';
  const rows = getFiltered();
  rows.forEach(r=>{
    const tr = document.createElement('tr'); tr.className='border-b';
    tr.innerHTML = '<td class="px-4 py-2">'+esc(r.cod)+'</td>' +
                   '<td class="px-4 py-2">'+esc(r.nombre)+'</td>' +
                   '<td class="px-4 py-2">'+esc(r.semana)+'</td>' +
                   '<td class="px-4 py-2">'+esc(r.dia)+'</td>' +
                   '<td class="px-4 py-2">'+esc(r.vendedor)+'</td>' +
                   '<td class="px-4 py-2">'+esc(r.gestor)+'</td>' +
                   '<td class="px-4 py-2">'+esc(r.empresa)+'</td>' +
                   '<td class="px-4 py-2 space-x-2"><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+r.lat+','+r.lon+'" class="px-3 py-1 bg-blue-600 text-white rounded text-xs">Visitar</a><button class="px-3 py-1 bg-indigo-600 text-white rounded text-xs" data-gestionar="'+esc(r.cod)+'">Gestionar</button></td>';
    tbody.appendChild(tr);
  });
  // gestionar click
  tbody.querySelectorAll('button[data-gestionar]').forEach(btn=> btn.addEventListener('click',()=> openGestion(btn.getAttribute('data-gestionar')) ));
}

function openGestion(cod){
  const r = DATA.joined.find(x=> x.cod===cod);
  if(!r) return;
  document.getElementById('ll_cliente').value = r.nombre+' — '+r.cod;
  document.getElementById('ll_cod').value = r.cod;
  document.getElementById('ll_vendedor').value = r.vendedor;
  document.getElementById('ll_gestor').value = r.gestor;
  document.getElementById('ll_fecha').value = new Date().toISOString().slice(0,16).replace('T',' ');
  showView('llamada');
}

// --------- MAPA ---------
function renderMap(){
  if(!map){
    map = L.map('map').setView([18.7357,-70.1627],8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
    setTimeout(()=> map.invalidateSize(), 200);
    window.addEventListener('resize', ()=> setTimeout(()=> map.invalidateSize(), 150));
  } else {
    map.setView([18.7357,-70.1627],8);
  }
  markers.forEach(m=> m.remove()); markers=[];
  getFiltered().filter(r=>!isNaN(r.lat) && !isNaN(r.lon)).forEach(r=>{
    const m = L.marker([r.lat,r.lon]).addTo(map);
    m.bindPopup('<b>'+esc(r.nombre)+'</b><br>'+esc(r.cod)+'<br>Semana: '+esc(r.semana)+'<br>Día: '+esc(r.dia));
    markers.push(m);
  });
}

// --------- DATALISTS ---------
function fillDatalists(){
  const dl1 = document.getElementById('dl_clientes'), dl2 = document.getElementById('dl_clientes2');
  dl1.innerHTML=''; dl2.innerHTML='';
  DATA.joined.forEach(r=>{
    const v = r.nombre+' — '+r.cod;
    const o1=document.createElement('option'); o1.value=v; dl1.appendChild(o1);
    const o2=document.createElement('option'); o2.value=v; dl2.appendChild(o2);
  });
}

// --------- NAV ---------
function showView(id){
  document.querySelectorAll('main > section[data-view]').forEach(s=> s.classList.add('hidden'));
  const sec = document.querySelector('main > section[data-view="'+id+'"]');
  if(sec) sec.classList.remove('hidden');
  document.querySelectorAll('header .navbtn').forEach(b=> b.classList.toggle('active', b.getAttribute('data-view')===id));
}
document.getElementById('btnRegistrarLlamada').onclick = ()=> showView('llamada');
document.getElementById('ll_cancel').onclick = ()=> showView('mapa');
document.getElementById('btnAsignarSemana').onclick = ()=> showView('asignar');
document.getElementById('asig_cancel').onclick = ()=> showView('mapa');
document.getElementById('btnRefrescar').onclick = async ()=>{ await loadClientesCalendario(); buildJoined(); renderFilters(); renderMap(); renderTable(); fillDatalists(); };
document.querySelectorAll('header .navbtn').forEach(b=> b.addEventListener('click', ()=> showView(b.getAttribute('data-view')) ));

// Export
document.getElementById('btnExport').onclick = ()=>{
  const headers = ['Cod Empresa','Cliente','Semana','Dia','Vendedor','gestor_servicio','Empresa'];
  const rows = getFiltered().map(r=>[r.cod,r.nombre,r.semana,r.dia,r.vendedor,r.gestor,r.empresa]);
  const csv = [headers.join(','), ...rows.map(r=> r.map(x=>'"'+(x??'').toString().replace(/"/g,'""')+'"').join(','))].join('\n');
  const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='clientes_filtrados.csv'; a.click(); URL.revokeObjectURL(url);
};
</script>
</body></html>
