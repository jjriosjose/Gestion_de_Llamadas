<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CRM de Llamadas — v7.6.1</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
header{position:sticky;top:0;z-index:50}
.card{border-radius:1rem;box-shadow:0 8px 20px rgba(0,0,0,.06)}
.navbtn{padding:.4rem .8rem;border-radius:.6rem;background:#eef2f7}
.navbtn.active{background:#111827;color:#fff}
#map{min-height:420px}
.badge{font-size:.7rem;padding:.1rem .4rem;border-radius:.35rem}
.badge-gray{background:#e5e7eb;color:#374151}
.badge-blue{background:#dbeafe;color:#1e40af}
.badge-green{background:#dcfce7;color:#166534}
.badge-yellow{background:#fef9c3;color:#854d0e}
.badge-red{background:#fee2e2;color:#991b1b}
tr.hoverable:hover{background:#f9fafb}
.leaflet-popup-content{margin:6px 8px}
</style>
</head>
<body class="bg-gray-100 text-gray-900">
<header class="bg-white shadow p-3">
  <div class="max-w-7xl mx-auto flex items-center justify-between">
    <div class="flex items-center space-x-3">
      <span class="inline-flex h-7 w-7 items-center justify-center rounded-lg bg-indigo-600 text-white font-bold">C</span>
      <h1 class="font-bold text-lg">CRM de Llamadas</h1>
      <span class="text-xs px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded-full">v7.6.1</span>
    </div>
    <nav class="flex gap-2">
      <button class="navbtn active" data-view="mapa"><i class="fa fa-map"></i> Mapa</button>
      <button class="navbtn" data-view="llamada"><i class="fa fa-phone"></i> Registrar llamada</button>
      <button class="navbtn" data-view="asignar"><i class="fa fa-calendar-week"></i> Asignar semana/día</button>
      <button class="navbtn" data-view="reporte"><i class="fa fa-chart-column"></i> Reporte</button>
    </nav>
  </div>
</header>

<section id="loginSection" class="max-w-md mx-auto mt-10 bg-white p-6 card">
  <h2 class="font-semibold text-lg mb-4"><i class="fa fa-lock"></i> Acceso</h2>
  <form id="loginForm" class="space-y-3">
    <div>
      <label class="block text-sm">Usuario</label>
      <input id="loginUser" class="w-full p-2 border rounded" autocomplete="username" required>
    </div>
    <div>
      <label class="block text-sm">Contraseña</label>
      <input id="loginPass" type="password" class="w-full p-2 border rounded" autocomplete="current-password" required>
    </div>
    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Entrar</button>
    <p class="text-xs text-gray-500">Se valida contra la hoja <em>Usuarios</em> publicada.</p>
  </form>
  <div id="loginError" class="mt-3 text-sm text-red-600 hidden"></div>
</section>

<main id="appSection" class="hidden max-w-7xl mx-auto mt-6 px-4">
  <div class="bg-white p-4 card mb-4">
    <div class="flex flex-wrap gap-2 items-center">
      <button id="btnRegistrarLlamada" class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"><i class="fa fa-phone"></i> Registrar llamada</button>
      <button id="btnAsignarSemana" class="px-3 py-1.5 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm"><i class="fa fa-calendar-week"></i> Asignar semana/día</button>
      <button id="btnRefrescar" class="px-3 py-1.5 bg-gray-200 rounded hover:bg-gray-300 text-sm"><i class="fa fa-rotate"></i> Refrescar</button>
      <button id="btnExport" class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-sm"><i class="fa fa-file-export"></i> Exportar clientes CSV</button>
      <button id="btnExportCalendario" class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-sm"><i class="fa fa-table"></i> Exportar calendario CSV</button>
    </div>
  </div>

  <div class="bg-white p-4 card mb-6">
    <h3 class="font-semibold text-lg mb-2">Mapa de clientes</h3>
    <div id="map" class="w-full h-96 rounded"></div>
  </div>

  <div class="bg-white p-4 card mb-10">
    <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
      <div><label class="block text-sm">Semana</label><select id="fSemana" class="w-full p-2 border rounded"></select></div>
      <div><label class="block text-sm">Día</label><select id="fDia" class="w-full p-2 border rounded"></select></div>
      <div><label class="block text-sm">Vendedor</label><select id="fVendedor" class="w-full p-2 border rounded"></select></div>
      <div><label class="block text-sm">gestor_servicio</label><select id="fGestor" class="w-full p-2 border rounded"></select></div>
      <div><label class="block text-sm">Empresa</label><select id="fEmpresa" class="w-full p-2 border rounded"></select></div>
      <div><label class="block text-sm">Buscar</label><input id="fSearch" class="w-full p-2 border rounded" placeholder="Nombre o Cod Empresa"></div>
    </div>
    <div class="mt-5 overflow-x-auto">
      <table id="tablaClientes" class="min-w-full text-sm text-left text-gray-700 border">
        <thead class="bg-gray-50 text-xs uppercase">
          <tr>
            <th class="px-4 py-2">Cod Empresa</th>
            <th class="px-4 py-2">Cliente</th>
            <th class="px-4 py-2">Semana</th>
            <th class="px-4 py-2">Día</th>
            <th class="px-4 py-2">Vendedor</th>
            <th class="px-4 py-2">gestor_servicio</th>
            <th class="px-4 py-2">Empresa</th>
            <th class="px-4 py-2">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Llamada -->
  <section data-view="llamada" class="hidden">
    <div class="bg-white p-6 card">
      <h3 class="font-semibold text-lg mb-3"><i class="fa fa-phone"></i> Registrar llamada</h3>
      <form id="formLlamada" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><label class="block text-sm">Cliente</label><input list="dl_clientes" id="ll_cliente" class="w-full p-2 border rounded"><datalist id="dl_clientes"></datalist></div>
        <div><label class="block text-sm">Cod Empresa</label><input id="ll_cod" class="w-full p-2 border rounded" readonly></div>
        <div><label class="block text-sm">Vendedor</label><input id="ll_vendedor" class="w-full p-2 border rounded" readonly></div>
        <div><label class="block text-sm">gestor_servicio</label><input id="ll_gestor" class="w-full p-2 border rounded" readonly></div>
        <div><label class="block text-sm">Fecha y hora</label><input id="ll_fecha" class="w-full p-2 border rounded" readonly></div>
        <div><label class="block text-sm">Resultado</label>
          <select id="ll_resultado" class="w-full p-2 border rounded">
            <option>Exitosa</option><option>Pendiente</option><option>No contesta</option><option>Cliente no disponible</option>
          </select>
        </div>
        <div class="md:col-span-2 flex justify-end gap-2">
          <button type="button" id="ll_cancel" class="px-3 py-1.5 bg-gray-200 rounded hover:bg-gray-300">Cancelar</button>
          <button class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700">Guardar</button>
        </div>
      </form>
      <p class="text-xs text-gray-500 mt-2">Se descargará un CSV local con el registro (para importar a Sheets si se desea).</p>
    </div>
  </section>

  <!-- Asignar -->
  <section data-view="asignar" class="hidden">
    <div class="bg-white p-6 card">
      <h3 class="font-semibold text-lg mb-3"><i class="fa fa-calendar-week"></i> Asignar semana/día</h3>
      <form id="formAsignar" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="md:col-span-2"><label class="block text-sm">Cliente</label><input list="dl_clientes2" id="asig_cliente" class="w-full p-2 border rounded"><datalist id="dl_clientes2"></datalist></div>
        <div><label class="block text-sm">Semana</label><input id="asig_semana" type="number" min="1" max="53" class="w-full p-2 border rounded"></div>
        <div><label class="block text-sm">Día</label>
          <select id="asig_dia" class="w-full p-2 border rounded">
            <option>Lunes</option><option>Martes</option><option>Miércoles</option>
            <option>Jueves</option><option>Viernes</option><option>Sábado</option><option>Domingo</option>
          </select>
        </div>
        <div class="md:col-span-2 flex justify-end gap-2">
          <button type="button" id="asig_cancel" class="px-3 py-1.5 bg-gray-200 rounded hover:bg-gray-300">Cancelar</button>
          <button class="px-3 py-1.5 bg-yellow-600 text-white rounded hover:bg-yellow-700">Aplicar</button>
        </div>
      </form>
      <p class="text-xs text-gray-500 mt-2">La modificación se refleja en la interfaz y podrá exportarse con <b>Exportar calendario CSV</b>.</p>
    </div>
  </section>

  <!-- Reporte -->
  <section data-view="reporte" class="hidden">
    <div class="bg-white p-6 card">
      <h3 class="font-semibold text-lg mb-3"><i class="fa fa-chart-column"></i> Reporte</h3>
      <p class="text-sm text-gray-600">Próximo: conexión directa a Google Sheets para consolidar llamadas.</p>
    </div>
  </section>
</main>

<script>
// ======= CONFIG =======
const URLS = {
  clientes: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1016315198&single=true&output=csv",
  calendario: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv",
  usuarios: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv"
};
const KEY = "Cod Empresa";
const RD_CENTER = [18.7357,-70.1627];
const norm = s => (s??"").toString().replace(/\\u00A0/g,' ').replace(/\\s+/g,' ').trim().toLowerCase();
const esc = s => s==null? "": String(s);
const parseNum = v => {
  if(v==null) return NaN;
  const t = String(v).replace(',', '.').trim();
  const n = parseFloat(t);
  return isNaN(n)? NaN : n;
};
const todayStr = () => {
  const d = new Date();
  return d.toISOString().slice(0,16).replace('T',' ');
};

let SESSION = { user:'', rawUserRow:null };
let DATA = { usuarios:[], clientes:[], calendario:[], joined:[], llamadas:[] };
let map, markers=[], markerIndex = new Map();

// ======= LOGIN =======
document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const username = norm(document.getElementById('loginUser').value);
  const pass = document.getElementById('loginPass').value;
  const err = document.getElementById('loginError');
  err.classList.add('hidden'); err.textContent="";
  try{
    DATA.usuarios = await loadCSV(URLS.usuarios);
    const row = DATA.usuarios.find(r => norm(r['Usuario']||r['Login']||r['gestor_servicio']) === username);
    if(!row) throw new Error('Usuario no encontrado');
    const clave = (row['Contrasena']||row['Contraseña']||row['Password']||'').toString();
    if(clave && clave !== pass) throw new Error('Contraseña inválida');
    SESSION.user = row['Usuario']||row['Login']||row['gestor_servicio']||'';
    SESSION.rawUserRow = row;
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('appSection').classList.remove('hidden');
    await loadClientesCalendario();
    buildJoined();
    renderFilters();
    renderMap(); renderTable(); fillDatalists();
  }catch(ex){
    err.textContent = "⚠️ " + ex.message;
    err.classList.remove('hidden');
  }
});

// ======= CSV LOADER =======
function loadCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{header:true,download:true,skipEmptyLines:true,
      complete: res => resolve(res.data.map(r=>{const o={}; for(const k in r){o[k]=r[k]; o[k.trim()]=r[k];} return o;})),
      error: err => reject(err)
    });
  });
}
async function loadClientesCalendario(){
  const [c, cal] = await Promise.all([ loadCSV(URLS.clientes), loadCSV(URLS.calendario) ]);
  DATA.clientes = c; DATA.calendario = cal;
}

// ======= JOIN =======
function getSemana(r){ return r['Semana']||r['SEMANA']||r['NumSemana']||r['Sem']||r['semana']||r['SEM']; }
function getDia(r){
  return r['Dia']||r['Día']||r['DIA']||r['dia']||r['Día de visita']||r['Dia_visita']||r['Dia semana']||r['DOW'];
}
function buildJoined(){
  const idx = {};
  DATA.calendario.forEach(r=>{ const k = norm(r[KEY]); if(k) idx[k]=r;});
  DATA.joined = DATA.clientes.map(c=>{
    const k = norm(c[KEY]);
    const m = idx[k];
    return {
      cod: c[KEY]||'',
      nombre: c['NombreCliente']||c['Cliente']||c['RazonSocial']||c['Razón Social']||'',
      lat: parseNum(c['Latitud']||c['LATITUD']||c['latitud']||c['lat']),
      lon: parseNum(c['Longitud']||c['LONGITUD']||c['longitud']||c['lng']),
      semana: m ? (getSemana(m)||'Por asignar') : 'Por asignar',
      dia: m ? (getDia(m)||'Por asignar') : 'Por asignar',
      vendedor: c['Vendedor']||c['VENDEDOR']||c['vendedor']||'',
      gestor: c['gestor_servicio']||c['GESTOR_SERVICIO']||c['Gestor']||'',
      empresa: c['Empresa']||c['EMPRESA']||c['empresa']||''
    };
  });
}

// ======= FILTERS =======
function uniq(a){ return Array.from(new Set(a.filter(v=>v!==undefined))).sort((x,y)=> String(x??'').localeCompare(String(y??''))); }
function setOpts(sel, arr){ sel.innerHTML=''; arr.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent= v===''?'Todos':v; sel.appendChild(o); }); }
function renderFilters(){
  setOpts(document.getElementById('fSemana'), ['','Por asignar', ...uniq(DATA.joined.map(r=>r.semana).filter(v=>v && v!=='Por asignar'))]);
  setOpts(document.getElementById('fDia'), ['','Por asignar', ...uniq(DATA.joined.map(r=>r.dia).filter(v=>v && v!=='Por asignar'))]);
  setOpts(document.getElementById('fVendedor'), [''].concat(uniq(DATA.joined.map(r=>r.vendedor).filter(Boolean))));
  setOpts(document.getElementById('fGestor'), [''].concat(uniq(DATA.joined.map(r=>r.gestor).filter(Boolean))));
  setOpts(document.getElementById('fEmpresa'), [''].concat(uniq(DATA.joined.map(r=>r.empresa).filter(Boolean))));
  ['fSemana','fDia','fVendedor','fGestor','fEmpresa'].forEach(id=> document.getElementById(id).addEventListener('change', ()=>{renderMap(true);renderTable();}));
  document.getElementById('fSearch').addEventListener('input', ()=>{renderMap(true);renderTable();});
}

// Current filter set
function getFiltered(){
  const fS = document.getElementById('fSemana').value;
  const fD = document.getElementById('fDia').value.toLowerCase();
  const fV = document.getElementById('fVendedor').value;
  const fG = document.getElementById('fGestor').value;
  const fE = document.getElementById('fEmpresa').value;
  const q = norm(document.getElementById('fSearch').value);
  return DATA.joined.filter(r=>{
    const okS = !fS || String(r.semana)===fS;
    const okD = !fD || String(r.dia||'').toLowerCase()===fD;
    const okV = !fV || r.vendedor===fV;
    const okG = !fG || r.gestor===fG;
    const okE = !fE || r.empresa===fE;
    const okQ = !q || norm(r.cod).includes(q) || norm(r.nombre).includes(q);
    return okS && okD && okV && okG && okE && okQ;
  });
}

// ======= COLOR UTILS (por vendedor) =======
function hashColor(str){
  // Deterministic pastel-ish color
  let h=0;
  for(let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i))>>>0;
  const hue = h % 360;
  return `hsl(${hue},70%,45%)`;
}

// ======= MAP =======
function renderMap(fit=false){
  if(!map){
    map = L.map('map').setView(RD_CENTER,8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
    setTimeout(()=> map.invalidateSize(), 200);
    window.addEventListener('resize', ()=> setTimeout(()=> map.invalidateSize(), 150));
  } else if(!fit){
    // keep view unless fitting
    map.setView(map.getCenter(), map.getZoom());
  }
  // clear
  markers.forEach(m=> m.remove()); markers=[]; markerIndex.clear();

  const rows = getFiltered().filter(r=>!isNaN(r.lat) && !isNaN(r.lon));
  const group = L.featureGroup();
  rows.forEach(r=>{
    const color = hashColor(r.vendedor||'Sin vendedor');
    const m = L.circleMarker([r.lat,r.lon], {radius:8, weight:2, color:color, fillOpacity:.25}).addTo(map);
    m.bindPopup(`<b>${esc(r.nombre)}</b><br>${esc(r.cod)}<br>Semana: ${esc(r.semana)}<br>Día: ${esc(r.dia)}<br><span class="badge badge-blue">${esc(r.vendedor||'Sin vendedor')}</span>`);
    markers.push(m); markerIndex.set(r.cod, m); group.addLayer(m);
  });
  if(rows.length===1){
    const m = markers[0];
    if(m){ map.setView(m.getLatLng(), 14); m.openPopup(); }
  } else if(rows.length>0 && fit){
    map.fitBounds(group.getBounds().pad(0.2));
  } else if(rows.length===0){
    map.setView(RD_CENTER,8);
  }
}

// ======= TABLE =======
function renderTable(){
  const tbody = document.querySelector('#tablaClientes tbody'); tbody.innerHTML='';
  const rows = getFiltered();
  rows.forEach(r=>{
    const tr = document.createElement('tr'); tr.className='border-b hoverable';
    tr.innerHTML = '<td class="px-4 py-2">'+esc(r.cod)+'</td>' +
                   '<td class="px-4 py-2">'+esc(r.nombre)+'</td>' +
                   '<td class="px-4 py-2">'+esc(r.semana)+'</td>' +
                   '<td class="px-4 py-2">'+esc(r.dia)+'</td>' +
                   '<td class="px-4 py-2">'+esc(r.vendedor)+'</td>' +
                   '<td class="px-4 py-2">'+esc(r.gestor)+'</td>' +
                   '<td class="px-4 py-2">'+esc(r.empresa)+'</td>' +
                   '<td class="px-4 py-2 space-x-2">' +
                     '<a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+r.lat+','+r.lon+'" class="px-3 py-1 bg-blue-600 text-white rounded text-xs">Visitar</a>' +
                     '<button class="px-3 py-1 bg-indigo-600 text-white rounded text-xs" data-gestionar="'+esc(r.cod)+'">Gestionar</button>' +
                   '</td>';
    // click para centrar
    tr.addEventListener('click', (ev)=>{
      // evitar si click en botón/anchor
      if(ev.target.tagName.toLowerCase()==='a' || ev.target.hasAttribute('data-gestionar')) return;
      const mk = markerIndex.get(r.cod);
      if(mk){ map.setView(mk.getLatLng(), 14); mk.openPopup(); }
    });
    tbody.appendChild(tr);
  });
  // gestionar click
  tbody.querySelectorAll('button[data-gestionar]').forEach(btn=> btn.addEventListener('click',()=> openGestion(btn.getAttribute('data-gestionar')) ));
}

// ======= DATALISTS =======
function fillDatalists(){
  const dl1 = document.getElementById('dl_clientes'), dl2 = document.getElementById('dl_clientes2');
  dl1.innerHTML=''; dl2.innerHTML='';
  DATA.joined.forEach(r=>{
    const v = r.nombre+' — '+r.cod;
    const o1=document.createElement('option'); o1.value=v; dl1.appendChild(o1);
    const o2=document.createElement('option'); o2.value=v; dl2.appendChild(o2);
  });
}

// ======= GESTION / FORM =======
function openGestion(cod){
  const r = DATA.joined.find(x=> x.cod===cod);
  if(!r) return;
  document.getElementById('ll_cliente').value = r.nombre+' — '+r.cod;
  document.getElementById('ll_cod').value = r.cod;
  document.getElementById('ll_vendedor').value = r.vendedor;
  document.getElementById('ll_gestor').value = r.gestor;
  document.getElementById('ll_fecha').value = todayStr();
  showView('llamada');
}

document.getElementById('formLlamada').addEventListener('submit', (e)=>{
  e.preventDefault();
  const row = {
    FechaHora: document.getElementById('ll_fecha').value || todayStr(),
    Usuario: SESSION.user || '',
    Cliente: document.getElementById('ll_cliente').value,
    CodEmpresa: document.getElementById('ll_cod').value,
    Vendedor: document.getElementById('ll_vendedor').value,
    Gestor: document.getElementById('ll_gestor').value,
    Resultado: document.getElementById('ll_resultado').value
  };
  DATA.llamadas.push(row);
  // descarga CSV incremental
  const headers = Object.keys(row);
  const csvLines = [headers.join(',')].concat(DATA.llamadas.map(r=> headers.map(h=>('"'+(r[h]??'').toString().replace(/"/g,'""')+'"')).join(',')));
  const blob = new Blob([csvLines.join('\\n')],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='llamadas_registro.csv'; a.click(); URL.revokeObjectURL(url);
  alert('✅ Llamada guardada localmente (CSV descargado).');
  showView('mapa');
});
document.getElementById('ll_cancel').onclick = ()=> showView('mapa');

// ======= ASIGNAR =======
document.getElementById('btnAsignarSemana').onclick = ()=> showView('asignar');
document.getElementById('asig_cancel').onclick = ()=> showView('mapa');
document.getElementById('formAsignar').addEventListener('submit', (e)=>{
  e.preventDefault();
  const val = document.getElementById('asig_cliente').value;
  const cod = (val.split('—')[1]||'').trim();
  const semana = document.getElementById('asig_semana').value;
  const dia = document.getElementById('asig_dia').value;
  if(!cod){ alert('Seleccione un cliente válido.'); return; }
  // actualizar en memoria (calendario + joined)
  let found = false;
  for(const r of DATA.calendario){
    if(norm(r[KEY])===norm(cod)){ r['Semana']=semana; r['Dia']=dia; found = true; break; }
  }
  if(!found){
    const row = {}; row[KEY]=cod; row['Semana']=semana; row['Dia']=dia; DATA.calendario.push(row);
  }
  buildJoined();
  renderFilters(); renderMap(true); renderTable();
  alert('✅ Asignación aplicada (en memoria). Use "Exportar calendario CSV" para descargar.');
});

// ======= NAV =======
function showView(id){
  document.querySelectorAll('main > section[data-view]').forEach(s=> s.classList.add('hidden'));
  const sec = document.querySelector('main > section[data-view="'+id+'"]');
  if(sec) sec.classList.remove('hidden');
  if(id==='llamada'){ setTimeout(()=>{ document.querySelector('section[data-view="llamada"]').scrollIntoView({behavior:'smooth'}); },50); }

  document.querySelectorAll('header .navbtn').forEach(b=> b.classList.toggle('active', b.getAttribute('data-view')===id));
}
document.getElementById('btnRegistrarLlamada').onclick = ()=> showView('llamada');
document.getElementById('btnRefrescar').onclick = async ()=>{
  await loadClientesCalendario(); buildJoined();
  renderFilters(); renderMap(true); renderTable(); fillDatalists();
};
document.querySelectorAll('header .navbtn').forEach(b=> b.addEventListener('click', ()=> showView(b.getAttribute('data-view')) ));

// ======= EXPORTS =======
document.getElementById('btnExport').onclick = ()=>{
  const headers = ['Cod Empresa','Cliente','Semana','Dia','Vendedor','gestor_servicio','Empresa','Latitud','Longitud'];
  const rows = getFiltered().map(r=>[r.cod,r.nombre,r.semana,r.dia,r.vendedor,r.gestor,r.empresa,r.lat,r.lon]);
  const csv = [headers.join(','), ...rows.map(r=> r.map(x=>'"'+(x??'').toString().replace(/"/g,'""')+'"').join(','))].join('\\n');
  const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='clientes_filtrados.csv'; a.click(); URL.revokeObjectURL(url);
};
document.getElementById('btnExportCalendario').onclick = ()=>{
  // exportar DATA.calendario tal cual, garantizando columnas KEY, Semana, Dia
  const headers = [KEY,'Semana','Dia'];
  const rows = DATA.calendario.map(r=> [r[KEY]||'', getSemana(r)||r['Semana']||'', getDia(r)||r['Dia']||'']);
  const csv = [headers.join(','), ...rows.map(r=> r.map(x=>'"'+(x??'').toString().replace(/"/g,'""')+'"').join(','))].join('\\n');
  const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='calendario_actualizado.csv'; a.click(); URL.revokeObjectURL(url);
};

// ======= INIT (noop until login) =======
</script>
</body>
</html>
