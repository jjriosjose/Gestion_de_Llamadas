<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gesti√≥n de Llamadas + Agenda Kanban</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<style>
  :root{ --bg:#0b1220; --card:#131c2b; --muted:#90a0b7; --text:#e8eef9; --primary:#2dd4bf; --danger:#ef4444; --chip:#1f2a40;}
  *{box-sizing:border-box;} body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:linear-gradient(180deg,#0b1220 0%,#0e1626 100%); color:var(--text);}
  a{ color: var(--primary); text-decoration:none;}
  .container{ max-width:1200px; margin:0 auto; padding:16px;}
  .app-title{ display:flex; align-items:center; gap:10px; margin:8px 0 16px;}
  .badge{ padding:2px 8px; border-radius:999px; background:var(--chip); color:#a7b3c8; font-size:12px;}
  .row{ display:flex; gap:16px; flex-wrap:wrap;} .col{ flex:1 1 320px; min-width:320px;}
  .card{ background:rgba(19,28,43,0.9); border:1px solid #22304a; border-radius:16px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
  .title{ font-size:18px; margin:0 0 6px;} .muted{ color:var(--muted); font-size:12px;}
  .grid{ display:grid; gap:8px;} .grid-2{ grid-template-columns:repeat(2,minmax(0,1fr)); } .grid-3{ grid-template-columns:repeat(3,minmax(0,1fr));}
  .filters{ display:grid; grid-template-columns:repeat(6,minmax(0,1fr)); gap:8px;}
  select,input[type="text"],input[type="password"],input[type="url"],textarea,input[type="number"],input[type="datetime-local"],input[type="date"],input[type="time"]{ width:100%; padding:10px; border-radius:10px; border:1px solid #314463; background:#0f1726; color:var(--text); outline:none;}
  textarea{ min-height:96px; resize:vertical;}
  .btn{ border:1px solid #28405f; background:#0f1726; color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer; transition:.15s; font-weight:600; font-size:12px;}
  .btn:hover{ transform:translateY(-1px);} .btn[disabled]{ opacity:.6; cursor:not-allowed;}
  .btn-primary{ background:linear-gradient(135deg,#1aa27f,#2dd4bf); border:0; color:#072018;} .btn-danger{ background:linear-gradient(135deg,#c2410c,#ef4444); border:0; color:#fff;}
  .btn-soft{ background:#101a2e; border:1px solid #2c3d5d;}
  .chip{ padding:2px 8px; font-size:11px; border-radius:999px; background:var(--chip); color:#a7b3c8; border:1px solid #2a3a59;}
  #map{ width:100%; height:62vh; border-radius:14px; overflow:hidden; border:1px solid #20314f; background:#0b1220;}
  .table{ width:100%; border-collapse:collapse; font-size:12px; border:1px solid #22304a; border-radius:12px; overflow:hidden;}
  .table th,.table td{ padding:8px 10px; border-bottom:1px solid #22304a;} .table th{ color:#9fb1cc; background:#0f182a; position:sticky; top:0; z-index:1;}
  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
  .errbar{ position:fixed; left:8px; right:8px; bottom:8px; background:#2a1220; border:1px solid #6b273d; color:#ffd0df; padding:8px 10px; border-radius:12px; display:none;}
  .hidden{ display:none !important;}
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:16px; z-index:10000; backdrop-filter: blur(2px);}
  .modal.hidden{ display:none !important;}
  .no-scroll{ overflow:hidden;}
  .card-compact{ padding:8px; border-radius:12px; border:1px solid #22304a; background:rgba(17,24,39,.7);}
  .status-chip{ font-size:11px; border:1px solid #2a3a59; padding:2px 8px; border-radius:999px; background:#0e1626; color:#cbd5e1;}
</style>
</head>
<body>
<div class="container">
  <div class="app-title">
    <h2 style="margin:0;">Gesti√≥n de Llamadas</h2>
    <span class="badge">LLAMADAS v7.6 (Agenda Kanban)</span>
    <span class="badge">Single‚ÄëFile</span>
  </div>

  <!-- LOGIN -->
  <section id="login" class="card">
    <h3 class="title">Ingreso</h3>
    <p class="muted">Demo: <code>demo / 1234</code> o <code>vendedor / 1234</code>. Conecta tus Google Sheets desde ‚öôÔ∏è <strong>Configurar</strong>.</p>
    <div class="grid grid-3">
      <div><label>Usuario</label><input id="loginUser" type="text" autocomplete="username"/></div>
      <div><label>Contrase√±a</label><input id="loginPass" type="password" autocomplete="current-password"/></div>
      <div class="grid"><label>&nbsp;</label><button id="btnLogin" class="btn btn-primary">Entrar</button></div>
    </div>
    <div class="toolbar" style="margin-top:6px;">
      <span class="chip">Modo: <span id="modeLabel">local</span></span>
      <span class="chip">Usuarios: <span id="usersCount">0</span></span>
      <button id="btnOpenConfig" class="btn btn-soft">‚öôÔ∏è Configurar</button>
    </div>
  </section>

  <!-- APP -->
  <section id="app" class="hidden">
    <div class="card">
      <div class="toolbar">
        <button id="btnToggleFiltros" class="btn btn-soft">‚ò∞ Filtros</button>
        <div class="toolbar">
          <button id="btnRegistrar" class="btn btn-soft" disabled>üìù Registrar llamada</button>
          <button id="btnReporte" class="btn btn-soft">üìä Reporte</button>
          <button id="btnAgenda" class="btn btn-soft">üóìÔ∏è Agenda</button>
          <button id="btnFicha" class="btn btn-soft" disabled>üëÅÔ∏è Ver ficha</button>
          <button id="btnNuevoCliente" class="btn btn-soft">‚ûï Nuevo cliente</button>
          <button id="btnExport" class="btn">‚≠≥ Exportar CSV</button>
          <button id="btnRestaurar" class="btn btn-danger">‚ü≤ Restaurar</button>
          <button id="btnOpenConfig2" class="btn btn-soft">‚öôÔ∏è Configurar</button>
          <button id="btnToggleLegend" class="btn btn-soft">üëÅÔ∏è Mostrar leyenda</button>
        </div>
        <div class="toolbar">
          <span class="chip">Clientes: <span id="statTotal">0</span></span>
          <span class="chip">Con coordenadas: <span id="statGeo">0</span></span>
          <span class="chip">Filtrados: <span id="statFilt">0</span></span>
        </div>
      </div>

      <!-- Filtros principales -->
      <div id="panelFiltros" class="card" style="margin-top:8px;">
        <div class="filters">
          <div><label>Semana</label><select id="fSemana"><option value="">Todas</option></select></div>
          <div><label>D√≠a</label><select id="fDia"><option value="">Todos</option></select></div>
          <div><label>Vendedor</label><select id="fVendedor"><option value="">Todos</option></select></div>
          <div><label>Gestor</label><select id="fGestor"><option value="">Todos</option></select></div>
          <div><label>Empresa</label><select id="fEmpresa"><option value="">Todas</option></select></div>
          <div><label>Buscar</label><input id="fBuscar" type="text" placeholder="Nombre o c√≥digo..."/></div>
        </div>
        <div style="margin-top:8px;" class="grid grid-2">
          <div><label>Cliente</label><select id="fCliente"><option value="">-- Seleccione --</option></select></div>
          <div class="toolbar hidden" id="legend"></div>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="col">
          <div id="map"></div>
          <div class="muted" id="hintZero" style="display:none; margin-top:6px;">No hay clientes con coordenadas en el filtro.</div>
        </div>
        <div class="col card">
          <h3 class="title">Clientes filtrados</h3>
          <div style="max-height:60vh; overflow:auto; border-radius:10px;">
            <table class="table" id="tbl">
              <thead><tr><th>Cod</th><th>Cliente</th><th>Semana</th><th>D√≠a</th><th>Vendedor</th><th>Gestor</th><th>Empresa</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Modal Config -->
<div id="modalConfig" class="modal hidden" aria-modal="true" role="dialog">
  <div class="card" style="width:min(860px,96vw);">
    <h3 class="title">Configuraci√≥n - Conectar Google Sheets</h3>
    <p class="muted">Pega las URL publicadas como CSV de tus hojas. <em>Tip:</em> usa ‚ÄúAplicar ahora‚Äù para ver cambios sin recargar.</p>
    <div class="grid grid-2">
      <div><label>Modo</label><select id="cfgMode"><option value="local">local (demo)</option><option value="sheets">sheets (Google)</option></select></div>
      <div><label>Usuarios (CSV)</label><input id="cfgUsuarios" type="url" placeholder="https://docs.google.com/.../pub?output=csv"/></div>
      <div><label>Clientes (CSV)</label><input id="cfgClientes" type="url" placeholder="https://docs.google.com/.../pub?output=csv"/></div>
      <div><label>Calendario (CSV)</label><input id="cfgCalendario" type="url" placeholder="https://docs.google.com/.../pub?output=csv"/></div>
    </div>
    <details style="margin-top:8px;">
      <summary>Filtros avanzados</summary>
      <div class="grid"><div><label>Excluir vendedores (uno por l√≠nea)</label><textarea id="cfgExcluirVendedores" placeholder="Nombres a excluir..."></textarea></div></div>
    </details>
    <div class="toolbar" style="margin-top:8px;">
      <button id="btnCfgProbar" class="btn">Probar conexi√≥n</button>
      <button id="btnCfgGuardar" class="btn btn-primary">Guardar & Recargar</button>
      <button id="btnCfgAplicar" class="btn">Aplicar ahora (sin recargar)</button>
      <button id="btnCfgLimpiar" class="btn btn-danger">Limpiar configuraci√≥n</button>
      <button id="btnCfgCerrar" class="btn btn-soft">Cerrar</button>
    </div>
    <p id="cfgStatus" class="muted" style="margin-top:6px;"></p>
  </div>
</div>

<!-- Modal Reporte -->
<div id="modalReporte" class="modal hidden" aria-modal="true" role="dialog">
  <div class="card" style="width:min(1100px,96vw);">
    <h3 class="title">üìä Reporte de llamadas</h3>
    <div class="grid grid-3">
      <div><label>Desde</label><input id="repDesde" type="date"/></div>
      <div><label>Hasta</label><input id="repHasta" type="date"/></div>
      <div><label>Vendedor</label><select id="repVendedor"><option value="">(todos)</option></select></div>
      <div><label>Gestor</label><select id="repGestor"><option value="">(todos)</option></select></div>
      <div><label>Resultado</label>
        <select id="repResultado"><option value="">(todos)</option><option>Exitosa</option><option>No contesta</option><option>Ocupado</option><option>N√∫mero equivocado</option><option>Rechazada</option></select>
      </div>
      <div><label>&nbsp;</label><button id="repExport" class="btn">‚¨á Exportar CSV</button></div>
    </div>
    <div style="margin-top:8px;max-height:60vh;overflow:auto;border-radius:10px;">
      <table class="table" id="repTbl">
        <thead><tr>
          <th>Fecha/Hora</th><th>Cliente</th><th>Cod</th><th>Vendedor</th><th>Gestor</th>
          <th>Resultado</th><th>Duraci√≥n</th><th>Obs</th><th>Provincia</th><th>Tel1</th><th>Cel</th><th>Cita</th>
        </tr></thead><tbody></tbody>
      </table>
    </div>
    <div class="toolbar" style="justify-content:flex-end; margin-top:10px;">
      <button id="btnRepCerrar" class="btn btn-soft">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal Agenda (Visitas programadas) -->
<div id="modalAgenda" class="modal hidden" aria-modal="true" role="dialog">
  <div class="card" style="width:min(1100px,96vw);">
    <h3 class="title">üóìÔ∏è Visitas programadas</h3>
    <div class="muted">Solo se muestran llamadas con cita.</div>

    <!-- Filtros de Agenda -->
    <div class="card" style="margin:10px 0;">
      <div class="grid grid-3">
        <div><label>Desde</label><input id="agDesde" type="date"/></div>
        <div><label>Hasta</label><input id="agHasta" type="date"/></div>
        <div><label>Estatus visita</label>
          <select id="agStatus">
            <option value="">(todos)</option>
            <option>programada</option>
            <option>asisti√≥</option>
            <option>no asisti√≥</option>
            <option>reprogramada</option>
            <option>cancelada</option>
          </select>
        </div>
        <div><label>Vendedor</label><select id="agVendedor"><option value="">(todos)</option></select></div>
        <div><label>Gestor</label><select id="agGestor"><option value="">(todos)</option></select></div>
        <div class="grid" style="align-items:end;">
          <div class="toolbar">
            <button id="btnAgendaExport" class="btn">‚¨á Exportar CSV</button>
            <button id="btnAgendaToggleCols" class="btn btn-soft">‚Üî Vista extendida</button>
            <div style="flex:1"></div>
            <button id="btnAgendaCerrar" class="btn btn-soft">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Atajos -->
    <div class="toolbar" style="margin-bottom:6px;">
      <button id="btnAgendaHoy" class="btn btn-soft">Hoy</button>
      <button id="btnAgendaSemana" class="btn btn-soft">Esta semana</button>
      <button id="btnAgendaTodas" class="btn btn-soft">Todas</button>
    </div>

    <div id="agendaCols" class="row" style="gap:12px;"></div>
  </div>
</div>

<div class="errbar" id="errbar"></div>

<script>
/* ======================= CONFIG BASICA ======================= */
const DEFAULT_CONFIG = { 
  mode:'local',
  sheets:{usuarios:'', clientes:'', calendario:''},
  excluirVendedores:[
    "CESAR CABA","DIOGENES ALCANTARA","EDUARD CEBALLOS","EVELYN OCHOA","JOSE","JOSE ALTAGRACIA SANCHEZ",
    "JOSE DE LA CRUZ","KARAKA INTERNO","LEGAL","LUISVI RAMOS","MANUEL","MANUEL EMILIO ALCANTARA","MOISES FELIZ",
    "NO ASIGNADO","RENDY ALBERTO MEJIA GUERRERO","ROLANDO ANT. SEBELEN","ROSMERY RIVAS","RYAN","RYAN BAEZ","SIN ASIGNAR",
    "VICTOR PEREZ","YUKI"
  ]
};
let CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG));

/* ======================= DEMO ======================= */
const DEMO = {
  usuarios:[
    { Usuario:'demo', Password:'1234', gestor_servicio:'RENDY MEJIA', Vendedor:'RENDY MEJIA' },
    { Usuario:'vendedor', Password:'1234', gestor_servicio:'DIOGENES', Vendedor:'DIOGENES' }
  ],
  clientes:[
    { 'Cod Empresa':'1001', RazonSocial:'FERRETERIA EL SOL', Latitud:'18.510', Longitud:'-69.850', Telefono1:'809-555-1111', Celular:'809-999-1111', Provincia:'La Altagracia', Vendedor:'RENDY MEJIA', gestor_servicio:'RENDY MEJIA', Empresa:'WILLIAM'},
    { 'Cod Empresa':'1002', RazonSocial:'PINTURAS CARIBE',   Latitud:'18,470', Longitud:'-69,900', Telefono1:'809-555-2222', Celular:'809-999-2222', Provincia:'Santo Domingo', Vendedor:'DIOGENES', gestor_servicio:'DIOGENES', Empresa:'WILLIAM'},
    { 'Cod Empresa':'1003', RazonSocial:'TODO HOGAR',        Latitud:'',       Longitud:'',       Telefono1:'809-555-3333', Celular:'809-999-3333', Provincia:'La Romana', Vendedor:'', gestor_servicio:'', Empresa:'WILLIAM'}
  ],
  calendario:[
    { 'Cod Empresa':'1001', Semana:'32', Dia:'Viernes' },
    { 'Cod Empresa':'1002', Semana:'32', Dia:'Jueves'  }
  ]
};

/* ======================= STATE ======================= */
const STATE = {
  calls:[], users:[], clientes:[], calendario:[], joined:[], filtered:[],
  currentUser:null, selected:null,
  map:null, markers:[], colorByVendedor:{}, iconByColor:{},
  agendaExtended:false
};

/* ======================= UTILIDADES ======================= */
const JOIN_KEYS = ['Cod Empresa','CodEmpresa','Cod_Empresa','codigo_empresa','codigo','CodEmp','CodEmpresaId'];
function norm(v){ return (v??'').toString().trim().toLowerCase(); }
function stripAccents(s){ return (s??'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function normName(s){ return stripAccents(String(s||'')).trim().toLowerCase(); }
function pick(row, keys){ for(const k of keys){ if(row && row[k]!=null && row[k]!=='') return row[k]; }
  const normRow={}; for(const key in row){ normRow[key.toLowerCase().replace(/\s|_/g,'')]=row[key]; }
  for(const k of keys){ const nk=k.toLowerCase().replace(/\s|_/g,''); if(nk in normRow) return normRow[nk]; } return ''; }
function getByGuess(row,patterns){ for(const key in row){ if(patterns.some(rx=>rx.test(key))) return row[key]; }
  const map={}; for(const k in row){ map[k.toLowerCase().replace(/\s|_/g,'')]=row[k]; }
  for(const nk in map){ if(patterns.some(rx=>rx.test(nk))) return map[nk]; } return ''; }
function parseCoord(val){ if(val==null) return NaN; const s=String(val).trim(); let cleaned=s.replace(/[^0-9,\.\-]/g,'');
  if(cleaned.includes('.')&&cleaned.includes(',')){ cleaned=cleaned.replace(/,/g,''); } else { cleaned=cleaned.replace(',','.'); }
  const num=parseFloat(cleaned); return isFinite(num)?num:NaN; }
function getLat(row){ const v=row['Latitud']||row['latitud']||row['LATITUD']||getByGuess(row,[/lat$/i,/^lat/i,/latitude/i]); return parseCoord(v); }
function getLon(row){ const v=row['Longitud']||row['longitud']||row['LONGITUD']||row['Lng']||row['lng']||getByGuess(row,[/lon$/i,/long/i,/lng/i]); return parseCoord(v); }
function uniqueSorted(arr){ return Array.from(new Set(arr.filter(x=>x!=null && x!==''))).sort((a,b)=>{ const na=Number(a), nb=Number(b); if(isFinite(na)&&isFinite(nb)) return na-nb; return String(a).localeCompare(String(b),'es',{numeric:true}); }); }
function showErr(msg){ const el=document.getElementById('errbar'); el.textContent=msg; el.style.display='block'; setTimeout(()=>{ el.style.display='none'; }, 4200); }
function hashColor(name){ const s=(name||'').toString(); let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h+s.charCodeAt(i); h|=0; } const hue=Math.abs(h)%360; return `hsl(${hue} 80% 55%)`; }
function vendorExcludedSet(){ const arr=CONFIG.excluirVendedores||[]; return new Set(arr.map(v=>normName(v)).filter(Boolean)); }
function isVendorExcluded(name){ if(!name) return false; return vendorExcludedSet().has(normName(name)); }

/* ======================= CSV LOADER ======================= */
async function fetchCSV(url){ const res=await fetch(url); if(!res.ok) throw new Error('HTTP '+res.status); const text=await res.text(); return parseCSV(text); }
function parseCSV(text){
  const rows=[]; const lines=text.split(/\r?\n/).filter(x=>x.trim().length>0); if(lines.length===0) return rows;
  const split=(line)=>{ const out=[]; let cur='', inQ=false; for(let i=0;i<line.length;i++){ const c=line[i],n=line[i+1];
    if(c==='\"'){ if(inQ&&n==='\"'){ cur+='\"'; i++; } else inQ=!inQ; } else if(c===','&&!inQ){ out.push(cur); cur=''; } else cur+=c; } out.push(cur); return out; };
  const headers=split(lines[0]).map(h=>h.trim());
  for(let i=1;i<lines.length;i++){ const vals=split(lines[i]); const row={}; headers.forEach((h,idx)=> row[h]= vals[idx]!==undefined ? vals[idx] : '' ); rows.push(row); }
  return rows;
}

/* ======================= DATA PREP ======================= */
function detectVendedor(row){
  const cand=row['Vendedor']||row['VENDEDOR']||row['vendedor']||row['Vendedor Asignado']||row['VENDEDOR ASIGNADO']||row['VendedorAsignado']||row['VENDEDOR_ASIGNADO']||getByGuess(row,[/vendedor/i,/seller/i,/salesrep/i]);
  if(cand && String(cand).trim()!=='') return cand;
  return row['gestor_servicio']||row['Gestor']||row['GESTOR_SERVICIO']||'';
}
function mapUserRecord(r){
  const u=r['Usuario']||r['usuario']||r['Login']||r['NombreUsuario']||r['USUARIO'];
  const p=r['Password']||r['Contrase√±a']||r['Contrasena']||r['PASS']||r['Clave'];
  return { Usuario:(u??'').toString(), Password:(p??'').toString(), gestor_servicio:r['gestor_servicio']||r['Gestor']||r['GESTOR_SERVICIO']||'', Vendedor:detectVendedor(r) };
}
function buildJoined(){
  const idxCal={}; const getDia=r=> r['Dia']??r['D√≠a']??r['dia']??r['DIA']; const getSem=r=> r['Semana']??r['SEMANA']??r['semana'];
  STATE.calendario.forEach(r=>{ const key=norm(pick(r,JOIN_KEYS)); if(!key) return; if(!idxCal[key]) idxCal[key]=r; });
  STATE.joined=STATE.clientes.map(c=>{
    const key=norm(pick(c,JOIN_KEYS)); const m=idxCal[key]; const semana=m?(getSem(m)||'Por asignar'):'Por asignar'; const dia=m?(getDia(m)||'Por asignar'):'Por asignar';
    const lat=getLat(c), lon=getLon(c), vendedor=detectVendedor(c);
    return { cod: pick(c,JOIN_KEYS)||'', nombre:c['NombreCliente']||c['Cliente']||c['RazonSocial']||c['RAZONSOCIAL']||'', semana, dia,
      vendedor, gestor:c['gestor_servicio']||c['Gestor']||c['GESTOR_SERVICIO']||'', empresa:c['Empresa']||c['EMPRESA']||'', lat, lon,
      telefono1:c['Telefono1']||c['TEL1']||c['Telefono']||c['Tel']||c['TEL']||'', celular:c['Celular']||c['CELULAR']||c['Movil']||c['M√≥vil']||'',
      provincia:c['Provincia']||c['PROVINCIA']||c['estado']||c['Departamento']||'' };
  });
  if((CONFIG.excluirVendedores||[]).length){ STATE.joined=STATE.joined.filter(x=> !isVendorExcluded(x.vendedor)); }
}

/* ======================= UI PRINCIPAL ======================= */
function fillSelect(id, arr, defLabel){ const el=document.getElementById(id); el.innerHTML=`<option value="">${defLabel}</option>` + arr.map(v=>`<option value="${String(v)}">${String(v)}</option>`).join(''); }
function buildLegend(){
  const legend=document.getElementById('legend'); legend.innerHTML='';
  uniqueSorted(STATE.joined.map(x=>x.vendedor))
    .filter(v=>!isVendorExcluded(v))
    .forEach(v=>{ const c=hashColor(v||''); const span=document.createElement('span'); span.className='chip'; span.style.borderColor=c; span.style.color='#dbe7ff'; span.textContent=v||'Sin vendedor'; legend.appendChild(span); });
}
function buildFilters(){
  const S=STATE.joined;
  fillSelect('fSemana', uniqueSorted(S.map(x=>x.semana)), 'Todas');
  fillSelect('fDia', uniqueSorted(S.map(x=>x.dia)), 'Todos');
  const vendOpts=uniqueSorted(S.map(x=>x.vendedor)).filter(v=>!isVendorExcluded(v));
  fillSelect('fVendedor', vendOpts, 'Todos');
  fillSelect('fGestor', uniqueSorted(S.map(x=>x.gestor)), 'Todos');
  fillSelect('fEmpresa', uniqueSorted(S.map(x=>x.empresa)), 'Todas');
  const opts=S.map(x=>({value:x.cod,label:`${x.cod} - ${x.nombre}`})).sort((a,b)=>a.label.localeCompare(b.label,'es',{numeric:true}));
  const sel=document.getElementById('fCliente'); sel.innerHTML='<option value="">-- Seleccione --</option>' + opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
  buildLegend();
}
function applyFilters(){
  const fSemana=val('fSemana'), fDia=val('fDia'), fVend=val('fVendedor'), fGes=val('fGestor'), fEmp=val('fEmpresa'), fBus=norm(val('fBuscar')), fCli=val('fCliente');
  STATE.filtered=STATE.joined.filter(x=>{
    if(isVendorExcluded(x.vendedor)) return false;
    if(fSemana && String(x.semana)!==String(fSemana)) return false;
    if(fDia && String(x.dia)!==String(fDia)) return false;
    if(fVend && String(x.vendedor)!==String(fVend)) return false;
    if(fGes && String(x.gestor)!==String(fGes)) return false;
    if(fEmp && String(x.empresa)!==String(fEmp)) return false;
    if(fCli && String(x.cod)!==String(fCli)) return false;
    if(fBus){ const hay=[x.cod,x.nombre,x.vendedor,x.gestor,x.empresa].map(v=>norm(v)).some(s=>s.includes(fBus)); if(!hay) return false; }
    return true;
  });
  renderTable(); renderMap(); updateStats(); updateButtonsState();
}
function val(id){ return document.getElementById(id).value; }
function renderTable(){ const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
  STATE.filtered.forEach(x=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.cod}</td><td>${x.nombre}</td><td>${x.semana}</td><td>${x.dia}</td><td>${x.vendedor}</td><td>${x.gestor}</td><td>${x.empresa}</td>`; tr.style.cursor='pointer'; tr.onclick=()=>selectCliente(x); tb.appendChild(tr); });
}

/* ===== Mapa ===== */
function initMap(){ if(STATE.map) return; const RD=[18.735693,-70.162651]; STATE.map=L.map('map',{zoomControl:true}).setView(RD,8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(STATE.map);
  setTimeout(()=>STATE.map.invalidateSize(),200); window.addEventListener('resize',()=>STATE.map&&STATE.map.invalidateSize()); }
function clearMarkers(){ STATE.markers.forEach(m=>STATE.map.removeLayer(m)); STATE.markers=[]; }
function getVendedorColor(v){ if(!v) return '#9aa3b2'; if(!STATE.colorByVendedor[v]) STATE.colorByVendedor[v]=hashColor(v); return STATE.colorByVendedor[v]; }
function svgPin(color){ const fill=color||'#3b82f6', stroke='#08121f';
  const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="26" height="38" viewBox="0 0 26 38">
  <path d="M13 0C7 0 2 5 2 11c0 7.5 9 17 11 19 2-2 11-11.5 11-19C24 5 19 0 13 0z" fill="${fill}" stroke="${stroke}" stroke-width="2"/>
  <circle cx="13" cy="12" r="4.2" fill="#fff" stroke="${stroke}" stroke-width="2"/></svg>`;
  return 'data:image/svg+xml;base64,'+btoa(svg); }
function pinIcon(color){ if(!STATE.iconByColor[color]){ STATE.iconByColor[color]=L.icon({ iconUrl:svgPin(color), iconSize:[26,38], iconAnchor:[13,36], popupAnchor:[0,-30], className:'vendor-pin' }); } return STATE.iconByColor[color]; }
function renderMap(){ initMap(); clearMarkers(); const bounds=[]; let rendered=0;
  STATE.filtered.forEach(x=>{
    if(!isFinite(x.lat)||!isFinite(x.lon)) return;
    const color=getVendedorColor(x.vendedor);
    const m=L.marker([x.lat,x.lon],{icon:pinIcon(color)}).addTo(STATE.map);
    m.bindPopup(`<strong>${x.nombre}</strong><div class="muted">Cod ${x.cod} ‚Ä¢ ${x.empresa||''}</div><div>Semana: ${x.semana} ‚Ä¢ D√≠a: ${x.dia}</div><div>Vendedor: ${x.vendedor||'-'} ‚Ä¢ Gestor: ${x.gestor||'-'}</div>`);
    m.on('click',()=>selectCliente(x)); STATE.markers.push(m); bounds.push([x.lat,x.lon]); rendered++;
  });
  document.getElementById('hintZero').style.display=rendered?'none':'block';
  if(bounds.length){ STATE.map.fitBounds(bounds,{padding:[20,20]}); } else { STATE.map.setView([18.735693,-70.162651],8); }
  setTimeout(()=>STATE.map.invalidateSize(),50);
}
function selectCliente(x){ STATE.selected=x; document.getElementById('fCliente').value=x.cod; renderMap(); updateButtonsState(); }
function updateButtonsState(){ const has=!!STATE.selected; document.getElementById('btnRegistrar').toggleAttribute('disabled',!has); document.getElementById('btnFicha').toggleAttribute('disabled',!has); }
function updateStats(){ const t=STATE.joined.length, g=STATE.joined.filter(x=>isFinite(x.lat)&&isFinite(x.lon)).length, f=STATE.filtered.length; document.getElementById('statTotal').textContent=t; document.getElementById('statGeo').textContent=g; document.getElementById('statFilt').textContent=f; }
function exportCSV(){ const headers=['Cod','Cliente','Semana','Dia','Vendedor','Gestor','Empresa','Latitud','Longitud']; const rows=STATE.filtered.map(x=>[x.cod,x.nombre,x.semana,x.dia,x.vendedor,x.gestor,x.empresa,x.lat||'',x.lon||'']); const csv=[headers.join(','),...rows.map(r=>r.map(csvEscape).join(','))].join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='clientes_filtrados.csv'; a.click(); URL.revokeObjectURL(a.href); }
function csvEscape(v){ if(v==null) return ''; const s=String(v); return (s.includes(',')||s.includes('"')||s.includes('\n'))?('"'+s.replace(/"/g,'""')+'"'):s; }

/* ======================= REGISTRO DE LLAMADA ======================= */
function formatDatetimeLocal(d){ const pad=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes()); }
function openCallModal(){
  if(!STATE.selected){ showErr('Debe seleccionar un cliente.'); return; }
  const x=STATE.selected;
  byId('callCliente').value=x.nombre||''; byId('callCodEmpresa').value=x.cod||''; byId('callVendedor').value=x.vendedor||''; byId('callGestor').value=x.gestor||'';
  byId('callFechaHora').value=formatDatetimeLocal(new Date()); byId('callResultado').value='Exitosa'; byId('callDuracion').value=0; byId('callObs').value='';
  byId('callTelefono1').value=x.telefono1||''; byId('callCelular').value=x.celular||''; byId('callProvincia').value=x.provincia||'';
  byId('callCitaTipo').value='sin_cita'; byId('callCitaFecha').value=''; byId('callCitaHora').value='';
  byId('callStatus').textContent=''; const m=byId('modalLlamada'); m.classList.remove('hidden'); m.style.display='flex'; document.body.classList.add('no-scroll');
}
function closeCallModal(){ const m=byId('modalLlamada'); m.classList.add('hidden'); m.style.display='none'; document.body.classList.remove('no-scroll'); }
function saveCallRecord(){
  if(!STATE.selected){ showErr('Debe seleccionar un cliente.'); return; }
  const record={
    cliente:byId('callCliente').value.trim(),
    cod_empresa:byId('callCodEmpresa').value.trim(),
    vendedor:byId('callVendedor').value.trim(),
    gestor_servicio:byId('callGestor').value.trim(),
    fecha_hora:byId('callFechaHora').value,
    resultado:byId('callResultado').value,
    duracion_seg:Number(byId('callDuracion').value||0),
    observaciones:byId('callObs').value.trim(),
    telefono1:byId('callTelefono1').value.trim(),
    celular:byId('callCelular').value.trim(),
    provincia:byId('callProvincia').value.trim(),
    cita_tipo:byId('callCitaTipo').value,
    cita_fecha:byId('callCitaFecha').value,
    cita_hora:byId('callCitaHora').value,
    // NUEVO: estatus de visita (por defecto "programada" si hay cita)
    cita_status:''
  };
  if(record.cita_tipo && record.cita_tipo!=='sin_cita' && record.cita_fecha) record.cita_status='programada';
  STATE.calls.push(record);
  try{ const prev=JSON.parse(localStorage.getItem('llamadas_records')||'[]'); prev.push(record); localStorage.setItem('llamadas_records',JSON.stringify(prev)); }catch(e){}
  byId('callStatus').textContent='Registro guardado localmente.'; setTimeout(()=>{ closeCallModal(); showErr('Llamada registrada.'); },400);
}

/* ======================= REPORTE ======================= */
function getAllRecords(){ let local=[]; try{ local=JSON.parse(localStorage.getItem('llamadas_records')||'[]'); }catch(_){}
  return [...local, ...STATE.calls]; }
function buildReporteDropdowns(){
  const all=getAllRecords();
  const vendedores=Array.from(new Set(all.map(r=>r.vendedor).filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),'es',{numeric:true}));
  const gestores=Array.from(new Set(all.map(r=>r.gestor_servicio).filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),'es',{numeric:true}));
  byId('repVendedor').innerHTML='<option value="">(todos)</option>'+vendedores.map(v=>`<option>${v}</option>`).join('');
  byId('repGestor').innerHTML  ='<option value="">(todos)</option>'+gestores.map(v=>`<option>${v}</option>`).join('');
}
function repFilters(){ return { desde:byId('repDesde').value, hasta:byId('repHasta').value, vend:byId('repVendedor').value, gest:byId('repGestor').value, res:byId('repResultado').value }; }
function renderReporte(){
  const all=getAllRecords(); const {desde,hasta,vend,gest,res}=repFilters();
  let ds=desde?new Date(desde+'T00:00:00'):null, hs=hasta?new Date(hasta+'T23:59:59'):null;
  const rows=all.filter(r=>{
    const d = r.fecha_hora? new Date(r.fecha_hora) : null;
    if(ds && d && d<ds) return false; if(hs && d && d>hs) return false;
    if(vend && String(r.vendedor)!==String(vend)) return false;
    if(gest && String(r.gestor_servicio)!==String(gest)) return false;
    if(res && String(r.resultado)!==String(res)) return false;
    return true;
  });
  const tb=byId('repTbl').querySelector('tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const cita=(r.cita_tipo && r.cita_tipo!=='sin_cita') ? (r.cita_tipo+' '+(r.cita_fecha||'')+' '+(r.cita_hora||'')) : '';
    const tr=document.createElement('tr');
    tr.innerHTML='<td>'+ (r.fecha_hora||'') +'</td>'+
                 '<td>'+ (r.cliente||'') +'</td>'+
                 '<td>'+ (r.cod_empresa||'') +'</td>'+
                 '<td>'+ (r.vendedor||'') +'</td>'+
                 '<td>'+ (r.gestor_servicio||'') +'</td>'+
                 '<td>'+ (r.resultado||'') +'</td>'+
                 '<td>'+ (r.duracion_seg||'') +'</td>'+
                 '<td>'+ (r.observaciones||'') +'</td>'+
                 '<td>'+ (r.provincia||'') +'</td>'+
                 '<td>'+ (r.telefono1||'') +'</td>'+
                 '<td>'+ (r.celular||'') +'</td>'+
                 '<td>'+ cita +'</td>';
    tb.appendChild(tr);
  });
}
function exportReporteCSV(){
  const tb=byId('repTbl').querySelector('tbody');
  const headers=['Fecha/Hora','Cliente','Cod','Vendedor','Gestor','Resultado','Duraci√≥n','Obs','Provincia','Tel1','Cel','Cita'];
  const rows=[...tb.querySelectorAll('tr')].map(tr=>[...tr.children].map(td=>td.textContent));
  const csv=[headers.join(','),...rows.map(r=>r.map(csvEscape).join(','))].join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='reporte_llamadas.csv'; a.click(); URL.revokeObjectURL(a.href);
}

/* ======================= AGENDA (KANBAN) ======================= */
const STATUS_OPTS = ['programada','asisti√≥','no asisti√≥','reprogramada','cancelada'];

function openAgenda(){ buildAgendaDropdowns(); renderAgenda('todas'); openModal(byId('modalAgenda')); }
function closeAgenda
