<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gesti√≥n de Llamadas - LLAMADAS v7.5.2</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root{
      --bg:#0b1220; --card:#131c2b; --muted:#90a0b7; --text:#e8eef9; --primary:#2dd4bf;
      --danger:#ef4444; --warning:#f59e0b; --success:#22c55e; --accent:#60a5fa;
      --chip:#1f2a40;
    }
    *{box-sizing:border-box;}
    body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:linear-gradient(180deg, #0b1220 0%, #0e1626 100%); color:var(--text);}
    a{ color: var(--primary); text-decoration: none;}
    .container{ max-width:1200px; margin:0 auto; padding:16px;}
    .app-title{ display:flex; align-items:center; gap:10px; margin:8px 0 16px;}
    .badge{ padding:2px 8px; border-radius:999px; background:var(--chip); color:var(--muted); font-size:12px;}
    .row{ display:flex; gap:16px; flex-wrap:wrap;}
    .col{ flex:1 1 320px; min-width:320px;}
    .card{ background:rgba(19,28,43,0.9); border:1px solid #22304a; border-radius:16px; padding:12px; box-shadow: 0 10px 30px rgba(0,0,0,.25);}
    .title{ font-size:18px; margin:0 0 6px;}
    .muted{ color:var(--muted); font-size:12px;}
    .grid{ display:grid; gap:8px;}
    .grid-2{ grid-template-columns: repeat(2, minmax(0,1fr));}
    .grid-3{ grid-template-columns: repeat(3, minmax(0,1fr));}
    .filters{ display:grid; grid-template-columns: repeat(6,minmax(0,1fr)); gap:8px;}
    @media (max-width: 960px){ .filters{ grid-template-columns: repeat(2,minmax(0,1fr)); } #map{ height:48vh; } }
    select, input[type="text"], input[type="password"], input[type="url"]{ width:100%; padding:10px; border-radius:10px; border:1px solid #314463; background:#0f1726; color:var(--text); outline:none;}
    select:focus, input:focus{ border-color: var(--primary); box-shadow: 0 0 0 3px rgba(45,212,191,.1);}
    .btn{ border:1px solid #28405f; background:#0f1726; color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer; transition: .15s transform ease, .15s background ease, .15s border ease; font-weight:600; font-size:12px;}
    .btn:hover{ transform: translateY(-1px); border-color:#35557f; background:#122039;}
    .btn-primary{ background: linear-gradient(135deg, #1aa27f, #2dd4bf); border:0; color:#072018;}
    .btn-danger{ background: linear-gradient(135deg, #c2410c, #ef4444); border:0; color:#fff;}
    .btn-soft{ background:#101a2e; border:1px solid #2c3d5d;}
    .chip{ padding:2px 8px; font-size:11px; border-radius:999px; background:var(--chip); color:#a7b3c8; border:1px solid #2a3a59;}
    #map{ width:100%; height:62vh; border-radius:14px; overflow:hidden; border:1px solid #20314f; background:#0b1220;}
    .table{ width:100%; border-collapse: collapse; font-size:12px; border:1px solid #22304a; border-radius:12px; overflow:hidden;}
    .table th, .table td{ padding:8px 10px; border-bottom:1px solid #22304a;}
    .table th{ text-align:left; color:#9fb1cc; background:#0f182a; position:sticky; top:0; z-index:1;}
    .table tr:hover{ background:#101a2e;}
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .legend{ display:flex; gap:8px; flex-wrap:wrap; }
    .legend .item{ display:flex; align-items:center; gap:6px; font-size:12px; color:#a7b3c8;}
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
    .footer{ margin-top:8px; font-size:11px; color:#7c8aa5;}
    .errbar{ position:fixed; left:8px; right:8px; bottom:8px; background:#2a1220; border:1px solid #6b273d; color:#ffd0df; padding:8px 10px; border-radius:12px; display:none;}
    .hidden{ display:none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="app-title">
      <h2 style="margin:0;">Gesti√≥n de Llamadas</h2>
      <span class="badge">LLAMADAS v7.5.2</span>
      <span class="badge">Single-File</span>
    </div>

    <!-- LOGIN -->
    <section id="login" class="card">
      <h3 class="title">Ingreso</h3>
      <p class="muted">Conecta tus Google Sheets publicados (CSV) desde ‚öôÔ∏è <strong>Configurar</strong>. Demo: <code>demo / 1234</code> o <code>vendedor / 1234</code>.</p>
      <div class="grid grid-3">
        <div>
          <label>Usuario</label>
          <input id="loginUser" type="text" placeholder="ej: rmejia" autocomplete="username" />
        </div>
        <div>
          <label>Contrase√±a</label>
          <input id="loginPass" type="password" placeholder="********" autocomplete="current-password" />
        </div>
        <div class="grid">
          <label>&nbsp;</label>
          <button id="btnLogin" class="btn btn-primary">Entrar</button>
        </div>
      </div>
      <div class="toolbar" style="margin-top:6px;">
        <span class="chip">Modo: <span id="modeLabel">local</span></span>
        <span class="chip">Usuarios: <span id="usersCount">0</span></span>
        <button id="btnOpenConfig" class="btn btn-soft">‚öôÔ∏è Configurar</button>
      </div>
    </section>

    <!-- APP -->
    <section id="app" class="hidden">
      <div class="card">
        <div class="toolbar">
          <button id="btnToggleFiltros" class="btn btn-soft">‚ò∞ Filtros</button>
          <div class="toolbar">
            <button id="btnRegistrar" class="btn btn-soft" disabled>üìù Registrar llamada</button>
            <button id="btnFicha" class="btn btn-soft" disabled>üëÅÔ∏è Ver ficha</button>
            <button id="btnNuevoCliente" class="btn btn-soft">‚ûï Nuevo cliente</button>
            <button id="btnExport" class="btn">‚≠≥ Exportar CSV</button>
            <button id="btnRestaurar" class="btn btn-danger">‚ü≤ Restaurar</button>
            <button id="btnOpenConfig2" class="btn btn-soft">‚öôÔ∏è Configurar</button>
          </div>
          <div class="toolbar">
            <span class="chip">Clientes: <span id="statTotal">0</span></span>
            <span class="chip">Con coordenadas: <span id="statGeo">0</span></span>
            <span class="chip">Filtrados: <span id="statFilt">0</span></span>
          </div>
        </div>

        <div id="panelFiltros" class="card" style="margin-top:8px;">
          <div class="filters">
            <div><label>Semana</label><select id="fSemana"><option value="">Todas</option></select></div>
            <div><label>D√≠a</label><select id="fDia"><option value="">Todos</option></select></div>
            <div><label>Vendedor</label><select id="fVendedor"><option value="">Todos</option></select></div>
            <div><label>Gestor</label><select id="fGestor"><option value="">Todos</option></select></div>
            <div><label>Empresa</label><select id="fEmpresa"><option value="">Todas</option></select></div>
            <div><label>Buscar</label><input id="fBuscar" type="text" placeholder="Nombre o c√≥digo..." /></div>
          </div>
          <div style="margin-top:8px;" class="grid grid-2">
            <div><label>Cliente</label><select id="fCliente"><option value="">-- Seleccione --</option></select></div>
            <div class="legend" id="legend"></div>
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="col">
            <div id="map"></div>
            <div class="footer" id="hintZero" style="display:none;">No hay clientes con coordenadas que coincidan con el filtro.</div>
          </div>
          <div class="col card">
            <h3 class="title">Clientes filtrados</h3>
            <div style="max-height:60vh; overflow:auto; border-radius:10px;">
              <table class="table" id="tbl">
                <thead>
                  <tr>
                    <th>Cod</th><th>Cliente</th><th>Semana</th><th>D√≠a</th><th>Vendedor</th><th>Gestor</th><th>Empresa</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal config simple -->
  <div class="hidden" id="modalConfig" style="position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; padding:16px;">
    <div class="card" style="width:min(780px,96vw);">
      <h3 class="title">Configuraci√≥n - Conectar Google Sheets</h3>
      <p class="muted">Pega las URL publicadas como CSV de tus hojas.</p>
      <div class="grid grid-2">
        <div>
          <label>Modo</label>
          <select id="cfgMode"><option value="local">local (demo)</option><option value="sheets">sheets (Google)</option></select>
        </div>
        <div>
          <label>Usuarios (CSV)</label>
          <input id="cfgUsuarios" type="url" placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"/>
        </div>
        <div>
          <label>Clientes (CSV)</label>
          <input id="cfgClientes" type="url" placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"/>
        </div>
        <div>
          <label>Calendario (CSV)</label>
          <input id="cfgCalendario" type="url" placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"/>
        </div>
      </div>
      <div class="toolbar" style="margin-top:8px;">
        <button id="btnCfgProbar" class="btn">Probar conexi√≥n</button>
        <button id="btnCfgGuardar" class="btn btn-primary">Guardar & Recargar</button>
        <button id="btnCfgLimpiar" class="btn btn-danger">Limpiar configuraci√≥n</button>
        <button id="btnCfgCerrar" class="btn btn-soft">Cerrar</button>
      </div>
      <p id="cfgStatus" class="muted" style="margin-top:6px;"></p>
    </div>
  </div>

  <div class="errbar" id="errbar"></div>

<script>
// ======================= CONFIG =======================
const DEFAULT_CONFIG = { mode:'local', sheets:{usuarios:'', clientes:'', calendario:''} };
let CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG));

// ======================= DEMO DATA =======================
const DEMO = {
  usuarios: [
    { Usuario:'demo', Password:'1234', gestor_servicio:'RENDY MEJIA', Vendedor:'RENDY MEJIA' },
    { Usuario:'vendedor', Password:'1234', gestor_servicio:'DIOGENES', Vendedor:'DIOGENES' }
  ],
  clientes: [
    { 'Cod Empresa':'1001', RazonSocial:'FERRETERIA EL SOL', Latitud:'18.510', Longitud:'-69.850', Telefono1:'809-555-1111', Celular:'809-999-1111', Provincia:'La Altagracia', Vendedor:'RENDY MEJIA', gestor_servicio:'RENDY MEJIA', Empresa:'WILLIAM'},
    { 'Cod Empresa':'1002', RazonSocial:'PINTURAS CARIBE',   Latitud:'18,470', Longitud:'-69,900', Telefono1:'809-555-2222', Celular:'809-999-2222', Provincia:'Santo Domingo', Vendedor:'DIOGENES', gestor_servicio:'DIOGENES', Empresa:'WILLIAM'},
    { 'Cod Empresa':'1003', RazonSocial:'TODO HOGAR',        Latitud:'',       Longitud:'',       Telefono1:'809-555-3333', Celular:'809-999-3333', Provincia:'La Romana', Vendedor:'', gestor_servicio:'', Empresa:'WILLIAM'}
  ],
  calendario: [
    { 'Cod Empresa':'1001', Semana:'32', Dia:'Viernes' },
    { 'Cod Empresa':'1002', Semana:'32', Dia:'Jueves'  }
  ]
};

// ======================= STATE =======================
const STATE = {
  users: [], clientes: [], calendario: [], joined: [], filtered: [],
  currentUser: null, selected: null,
  map: null, markers: [], colorByVendedor: {}
};

// ======================= UTILS =======================
const JOIN_KEYS = ['Cod Empresa','CodEmpresa','Cod_Empresa','codigo_empresa','codigo','CodEmp','CodEmpresaId'];

function norm(v){ return (v??'').toString().trim().toLowerCase(); }

function pick(row, keys){
  for(const k of keys){ if(row && row[k] != null && row[k] !== '') return row[k]; }
  const normRow = {};
  for(const key in row){ normRow[key.toLowerCase().replace(/\s|_/g,'')] = row[key]; }
  for(const k of keys){
    const nk = k.toLowerCase().replace(/\s|_/g,'');
    if(nk in normRow) return normRow[nk];
  }
  return '';
}

// Robust number parsing
function parseCoord(val){
  if(val==null) return NaN;
  const s = String(val).trim();
  let cleaned = s.replace(/[^0-9,\.\-]/g, '');
  if(cleaned.includes('.') && cleaned.includes(',')){ cleaned = cleaned.replace(/,/g,''); }
  else { cleaned = cleaned.replace(',', '.'); }
  const num = parseFloat(cleaned);
  return isFinite(num) ? num : NaN;
}

function getByGuess(row, patterns){
  for(const key in row){ if(patterns.some(rx=> rx.test(key))) return row[key]; }
  const map = {}; for(const k in row){ map[k.toLowerCase().replace(/\s|_/g,'')] = row[k]; }
  for(const nk in map){ if(patterns.some(rx=> rx.test(nk))) return map[nk]; }
  return '';
}

function getLat(row){
  const val = row['Latitud']||row['latitud']||row['LATITUD']||getByGuess(row,[/lat$/i,/^lat/i,/latitude/i]);
  return parseCoord(val);
}
function getLon(row){
  const val = row['Longitud']||row['longitud']||row['LONGITUD']||row['Lng']||row['lng']||getByGuess(row,[/lon$/i,/long/i,/lng/i]);
  return parseCoord(val);
}

function uniqueSorted(arr){
  return Array.from(new Set(arr.filter(x=>x!=null && x!==''))).sort((a,b)=>{
    const na = Number(a), nb = Number(b);
    if(isFinite(na) && isFinite(nb)) return na-nb;
    return String(a).localeCompare(String(b),'es',{numeric:true});
  });
}

function showErr(msg){
  const el = document.getElementById('errbar');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(()=>{ el.style.display = 'none'; }, 4200);
}

function hashColor(name){
  const s = (name||'').toString();
  let h=0; for(let i=0;i<s.length;i++){ h = (h<<5) - h + s.charCodeAt(i); h|=0; }
  const hue = Math.abs(h)%360;
  return `hsl(${hue} 80% 55%)`;
}

// ======================= CSV LOADER =======================
async function fetchCSV(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error('HTTP '+res.status);
  const text = await res.text();
  return parseCSV(text);
}

function parseCSV(text){
  const rows = [];
  const lines = text.split(/\r?\n/).filter(x=>x.trim().length>0);
  if(lines.length===0) return rows;
  const split = (line) => {
    const result=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i], n=line[i+1];
      if(c==='\"'){
        if(inQ && n==='\"'){ cur+='\"'; i++; }
        else inQ=!inQ;
      }else if(c===',' && !inQ){
        result.push(cur); cur='';
      }else cur+=c;
    }
    result.push(cur);
    return result;
  };
  const headers = split(lines[0]).map(h=>h.trim());
  for(let i=1;i<lines.length;i++){
    const vals = split(lines[i]);
    const row = {};
    headers.forEach((h,idx)=> row[h]= vals[idx]!==undefined ? vals[idx] : '' );
    rows.push(row);
  }
  return rows;
}

// ======================= DATA PREP =======================
function mapUserRecord(r){
  const u = r['Usuario']||r['usuario']||r['Login']||r['NombreUsuario']||r['USUARIO'];
  const p = r['Password']||r['Contrase√±a']||r['Contrasena']||r['PASS']||r['Clave'];
  return {
    Usuario: (u??'').toString(),
    Password: (p??'').toString(),
    gestor_servicio: r['gestor_servicio']||r['Gestor']||r['GESTOR_SERVICIO']||'',
    Vendedor: r['Vendedor']||r['VENDEDOR']||r['vendedor']||r['Vendedor Asignado']||r['VENDEDOR ASIGNADO']||r['VendedorAsignado']||r['VENDEDOR_ASIGNADO']||''
  };
}

function detectVendedor(row){
  const cand = row['Vendedor']||row['VENDEDOR']||row['vendedor']||
               row['Vendedor Asignado']||row['VENDEDOR ASIGNADO']||row['VendedorAsignado']||row['VENDEDOR_ASIGNADO']||
               getByGuess(row,[/vendedor/i,/seller/i,/salesrep/i]);
  if(cand && String(cand).trim()!=='') return cand;
  // Fallback: usar gestor si Vendedor vac√≠o
  return row['gestor_servicio']||row['Gestor']||row['GESTOR_SERVICIO']||'';
}

function buildJoined(){
  const idxCal = {};
  const getDia = r => r['Dia'] ?? r['D√≠a'] ?? r['dia'] ?? r['DIA'];
  const getSem = r => r['Semana'] ?? r['SEMANA'] ?? r['semana'];
  STATE.calendario.forEach(r=>{
    const key = norm(pick(r, JOIN_KEYS));
    if(!key) return;
    if(!idxCal[key]) idxCal[key] = r;
  });

  STATE.joined = STATE.clientes.map(c=>{
    const key = norm(pick(c, JOIN_KEYS));
    const m = idxCal[key];
    const semana = m ? (getSem(m) || 'Por asignar') : 'Por asignar';
    const dia    = m ? (getDia(m) || 'Por asignar') : 'Por asignar';
    const lat = getLat(c);
    const lon = getLon(c);
    return {
      cod: pick(c, JOIN_KEYS) || '',
      nombre: c['NombreCliente']||c['Cliente']||c['RazonSocial']||c['RAZONSOCIAL']||'',
      semana, dia,
      vendedor: detectVendedor(c),
      gestor: c['gestor_servicio']||c['Gestor']||c['GESTOR_SERVICIO']||'',
      empresa: c['Empresa']||c['EMPRESA']||'',
      lat, lon,
      Telefono1: c['Telefono1']||c['TEL']||'',
      Celular: c['Celular']||c['CEL']||'',
      Provincia: c['Provincia']||c['PROVINCIA']||''
    };
  });
}

function buildFilters(){
  const S = STATE.joined;
  const semanas = uniqueSorted(S.map(x=>x.semana));
  const dias    = uniqueSorted(S.map(x=>x.dia));
  const vends   = uniqueSorted(S.map(x=>x.vendedor));
  const gests   = uniqueSorted(S.map(x=>x.gestor));
  const emps    = uniqueSorted(S.map(x=>x.empresa));
  fillSelect('fSemana', semanas, 'Todas');
  fillSelect('fDia', dias, 'Todos');
  fillSelect('fVendedor', vends, 'Todos');
  fillSelect('fGestor', gests, 'Todos');
  fillSelect('fEmpresa', emps, 'Todas');
  const opts = S.map(x=>({value:x.cod, label:`${x.cod} - ${x.nombre}` })).sort((a,b)=>a.label.localeCompare(b.label,'es',{numeric:true}));
  const sel = document.getElementById('fCliente');
  sel.innerHTML = '<option value="">-- Seleccione --</option>' + opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
  buildLegend();
}

function fillSelect(id, arr, defLabel){
  const el = document.getElementById(id);
  el.innerHTML = `<option value="">${defLabel}</option>` + arr.map(v=>`<option value="${String(v)}">${String(v)}</option>`).join('');
}

function applyFilters(){
  const fSemana = document.getElementById('fSemana').value;
  const fDia    = document.getElementById('fDia').value;
  const fVend   = document.getElementById('fVendedor').value;
  const fGes    = document.getElementById('fGestor').value;
  const fEmp    = document.getElementById('fEmpresa').value;
  const fBus    = norm(document.getElementById('fBuscar').value);
  const fCli    = document.getElementById('fCliente').value;

  STATE.filtered = STATE.joined.filter(x=>{
    if(fSemana && String(x.semana)!==String(fSemana)) return false;
    if(fDia && String(x.dia)!==String(fDia)) return false;
    if(fVend && String(x.vendedor)!==String(fVend)) return false;
    if(fGes && String(x.gestor)!==String(fGes)) return false;
    if(fEmp && String(x.empresa)!==String(fEmp)) return false;
    if(fCli && String(x.cod)!==String(fCli)) return false;
    if(fBus){
      const hay = [x.cod, x.nombre, x.vendedor, x.gestor, x.empresa].map(v=>norm(v)).some(s=>s.includes(fBus));
      if(!hay) return false;
    }
    return true;
  });
  renderTable();
  renderMap();
  updateButtonsState();
  updateStats();
}

function renderTable(){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  STATE.filtered.forEach((x,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.cod}</td><td>${x.nombre}</td><td>${x.semana}</td><td>${x.dia}</td><td>${x.vendedor}</td><td>${x.gestor}</td><td>${x.empresa}</td>`;
    tr.style.cursor='pointer';
    tr.addEventListener('click', ()=> selectCliente(x));
    tb.appendChild(tr);
  });
}

function buildLegend(){
  const legend = document.getElementById('legend');
  legend.innerHTML = '';
  const vendSet = uniqueSorted(STATE.joined.map(x=>x.vendedor));
  vendSet.forEach(v=>{
    const c = getVendedorColor(v);
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `<span class="dot" style="background:${c}"></span>${v || 'Sin vendedor'}`;
    legend.appendChild(div);
  });
}

// ============== MAP ==============
function initMap(){
  if(STATE.map) return;
  // Centro por defecto: Rep√∫blica Dominicana
  const RD = [18.735693, -70.162651];
  STATE.map = L.map('map', { zoomControl: true }).setView(RD, 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(STATE.map);
  // Asegurar layout correcto al mostrarse
  setTimeout(()=> STATE.map.invalidateSize(), 250);
  window.addEventListener('resize', ()=> STATE.map && STATE.map.invalidateSize());
}

function clearMarkers(){
  STATE.markers.forEach(m=>STATE.map.removeLayer(m));
  STATE.markers = [];
}

function getVendedorColor(v){
  if(!v) return '#9aa3b2';
  if(!STATE.colorByVendedor[v]) STATE.colorByVendedor[v] = hashColor(v);
  return STATE.colorByVendedor[v];
}

function renderMap(){
  initMap();
  clearMarkers();
  const bounds = [];
  let rendered = 0;
  STATE.filtered.forEach(x=>{
    if(!isFinite(x.lat) || !isFinite(x.lon)) return;
    const color = getVendedorColor(x.vendedor);
    const marker = L.circleMarker([x.lat,x.lon], { radius: 8, weight: 2, color: '#0b1220', fillColor: color, fillOpacity: .9 });
    marker.bindPopup(`
      <div><strong>${x.nombre}</strong></div>
      <div class="muted">Cod ${x.cod} ‚Ä¢ ${x.empresa||''}</div>
      <div>Semana: ${x.semana} ‚Ä¢ D√≠a: ${x.dia}</div>
      <div>Vendedor: ${x.vendedor||'-'} ‚Ä¢ Gestor: ${x.gestor||'-'}</div>
      <div style="margin-top:6px;"><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${x.lat},${x.lon}">Ir con Google Maps ‚Üí</a></div>
    `);
    marker.on('click', ()=> selectCliente(x));
    marker.addTo(STATE.map);
    STATE.markers.push(marker);
    bounds.push([x.lat,x.lon]);
    rendered++;
  });
  document.getElementById('hintZero').style.display = rendered? 'none':'block';
  if(bounds.length){ STATE.map.fitBounds(bounds, {padding:[20,20]}); }
  else{
    // Sin coordenadas v√°lidas: centra en RD
    const RD = [18.735693, -70.162651];
    STATE.map.setView(RD, 8);
  }
  // revalidar tama√±o tras cambios de DOM
  setTimeout(()=> STATE.map.invalidateSize(), 50);
}

function selectCliente(x){
  STATE.selected = x;
  document.getElementById('fCliente').value = x.cod;
  renderMap(); // centra y re-renderiza
  STATE.markers.forEach(m=>{
    const latlng = m.getLatLng();
    if(Math.abs(latlng.lat - x.lat)<1e-8 && Math.abs(latlng.lng - x.lon)<1e-8) m.openPopup();
  });
  updateButtonsState();
}

function updateButtonsState(){
  const hasSel = !!STATE.selected;
  document.getElementById('btnRegistrar')?.toggleAttribute('disabled', !hasSel);
  document.getElementById('btnFicha')?.toggleAttribute('disabled', !hasSel);
}

function updateStats(){
  const total = STATE.joined.length;
  const geo = STATE.joined.filter(x=>isFinite(x.lat)&&isFinite(x.lon)).length;
  const filt = STATE.filtered.length;
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statGeo').textContent = geo;
  document.getElementById('statFilt').textContent = filt;
}

function exportCSV(){
  const headers = ['Cod','Cliente','Semana','Dia','Vendedor','Gestor','Empresa','Latitud','Longitud'];
  const rows = STATE.filtered.map(x=>[ x.cod, x.nombre, x.semana, x.dia, x.vendedor, x.gestor, x.empresa, x.lat||'', x.lon||'' ]);
  const csv = [headers.join(','), ...rows.map(r=>r.map(csvEscape).join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'clientes_filtrados.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function csvEscape(v){ if(v==null) return ''; const s=String(v); return (s.includes(',')||s.includes('"')||s.includes('\n'))?('"'+s.replace(/"/g,'""')+'"'):s; }

// ======================= LOGIN =======================
function doLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  if(!u || !p){ showErr('Ingrese usuario y contrase√±a.'); return; }
  const ok = STATE.users.find(x=> norm(x.Usuario)===norm(u) && String(x.Password)===String(p) );
  if(!ok){ showErr('Usuario o contrase√±a incorrectos.'); return; }
  document.getElementById('login').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  setTimeout(()=> STATE.map && STATE.map.invalidateSize(), 50);
  applyFilters();
}

// ======================= CONFIG MODAL =======================
function openConfig(){
  document.getElementById('cfgMode').value = CONFIG.mode;
  document.getElementById('cfgUsuarios').value = CONFIG.sheets.usuarios || '';
  document.getElementById('cfgClientes').value = CONFIG.sheets.clientes || '';
  document.getElementById('cfgCalendario').value = CONFIG.sheets.calendario || '';
  document.getElementById('cfgStatus').textContent = '';
  document.getElementById('modalConfig').classList.remove('hidden');
  setTimeout(()=> STATE.map && STATE.map.invalidateSize(), 50);
}
function closeConfig(){ document.getElementById('modalConfig').classList.add('hidden'); setTimeout(()=> STATE.map && STATE.map.invalidateSize(), 50); }
async function testConfig(){
  const u = document.getElementById('cfgUsuarios').value.trim();
  const c = document.getElementById('cfgClientes').value.trim();
  const k = document.getElementById('cfgCalendario').value.trim();
  const out = [];
  async function tryFetch(name, url){
    if(!url){ out.push(`${name}: (vac√≠o)`); return; }
    try{
      const arr = await fetchCSV(url);
      out.push(`${name}: OK (${arr.length} filas)`);
    }catch(e){ out.push(`${name}: ERROR (${e.message})`); }
  }
  await tryFetch('Usuarios', u);
  await tryFetch('Clientes', c);
  await tryFetch('Calendario', k);
  document.getElementById('cfgStatus').textContent = out.join(' ‚Ä¢ ');
}
function saveConfig(){
  const cfg = {
    mode: document.getElementById('cfgMode').value,
    sheets: {
      usuarios: document.getElementById('cfgUsuarios').value.trim(),
      clientes: document.getElementById('cfgClientes').value.trim(),
      calendario: document.getElementById('cfgCalendario').value.trim()
    }
  };
  localStorage.setItem('llamadas_config', JSON.stringify(cfg));
  location.reload();
}
function clearConfig(){ localStorage.removeItem('llamadas_config'); location.reload(); }

// ======================= INIT =======================
async function init(){
  // Load saved config
  try{
    const saved = JSON.parse(localStorage.getItem('llamadas_config')||'null');
    if(saved && typeof saved==='object'){
      CONFIG = Object.assign({}, DEFAULT_CONFIG, saved);
      CONFIG.sheets = Object.assign({}, DEFAULT_CONFIG.sheets, saved.sheets||{});
    }
  }catch(_){}
  document.getElementById('modeLabel').textContent = CONFIG.mode;

  // Load data
  if(CONFIG.mode==='sheets' && CONFIG.sheets.usuarios && CONFIG.sheets.clientes && CONFIG.sheets.calendario){
    try{
      STATE.users = (await fetchCSV(CONFIG.sheets.usuarios)).map(mapUserRecord);
      STATE.clientes = await fetchCSV(CONFIG.sheets.clientes);
      STATE.calendario = await fetchCSV(CONFIG.sheets.calendario);
    }catch(err){
      console.error(err);
      showErr('Error cargando hojas. Pasando a modo demo local.');
      fallbackToDemo();
    }
  }else{
    fallbackToDemo();
  }

  document.getElementById('usersCount').textContent = STATE.users.length;

  buildJoined();
  buildFilters();
  updateStats();
  applyFilters();

  // Events
  document.getElementById('btnLogin').addEventListener('click', doLogin);
  ['fSemana','fDia','fVendedor','fGestor','fEmpresa'].forEach(id=> document.getElementById(id).addEventListener('change', applyFilters));
  document.getElementById('fBuscar').addEventListener('input', applyFilters);
  document.getElementById('fCliente').addEventListener('change', ()=>{
    const cod = document.getElementById('fCliente').value;
    const x = STATE.joined.find(r=> String(r.cod)===String(cod) );
    if(x){ selectCliente(x); } else { STATE.selected=null; updateButtonsState(); }
  });
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('btnRestaurar').addEventListener('click', ()=>{
    ['fSemana','fDia','fVendedor','fGestor','fEmpresa'].forEach(id=> document.getElementById(id).value='');
    document.getElementById('fBuscar').value=''; document.getElementById('fCliente').value=''; STATE.selected=null; applyFilters();
  });
  document.getElementById('btnToggleFiltros').addEventListener('click', ()=>{
    const p = document.getElementById('panelFiltros'); p.style.display = (p.style.display==='none') ? 'block' : 'none'; setTimeout(()=> STATE.map && STATE.map.invalidateSize(), 50);
  });
  document.getElementById('btnOpenConfig').addEventListener('click', openConfig);
  document.getElementById('btnOpenConfig2').addEventListener('click', openConfig);
  document.getElementById('btnCfgCerrar').addEventListener('click', closeConfig);
  document.getElementById('btnCfgProbar').addEventListener('click', testConfig);
  document.getElementById('btnCfgGuardar').addEventListener('click', saveConfig);
  document.getElementById('btnCfgLimpiar').addEventListener('click', clearConfig);
}

function fallbackToDemo(){
  STATE.users = DEMO.usuarios.map(mapUserRecord);
  STATE.clientes = DEMO.clientes;
  STATE.calendario = DEMO.calendario;
}

window.addEventListener('DOMContentLoaded', ()=>{ init(); initMap(); });
</script>
</body>
</html>
