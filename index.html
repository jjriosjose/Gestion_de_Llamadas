<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gesti√≥n de Llamadas - LIVE</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root{ --bg:#0b1220; --card:#131c2b; --muted:#90a0b7; --text:#e8eef9; --primary:#2dd4bf; --danger:#ef4444; --chip:#1f2a40;}
    *{box-sizing:border-box;} body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:linear-gradient(180deg,#0b1220 0%,#0e1626 100%); color:var(--text);}
    a{ color: var(--primary); text-decoration: none;} .container{ max-width:1200px; margin:0 auto; padding:16px;}
    .app-title{ display:flex; align-items:center; gap:10px; margin:8px 0 16px;} .badge{ padding:2px 8px; border-radius:999px; background:var(--chip); color:#a7b3c8; font-size:12px;}
    .row{ display:flex; gap:16px; flex-wrap:wrap;} .col{ flex:1 1 320px; min-width:320px;}
    .card{ background:rgba(19,28,43,0.9); border:1px solid #22304a; border-radius:16px; padding:12px; box-shadow: 0 10px 30px rgba(0,0,0,.25);}
    .title{ font-size:18px; margin:0 0 6px;} .muted{ color:#90a0b7; font-size:12px;}
    .grid{ display:grid; gap:8px;} .grid-2{ grid-template-columns: repeat(2, minmax(0,1fr)); } .grid-3{ grid-template-columns: repeat(3, minmax(0,1fr));}
    .filters{ display:grid; grid-template-columns: repeat(6,minmax(0,1fr)); gap:8px;}
    select,input[type="text"],input[type="password"],input[type="url"],input[type="date"],input[type="time"],input[type="datetime-local"],textarea{ width:100%; padding:10px; border-radius:10px; border:1px solid #314463; background:#0f1726; color:var(--text); outline:none;}
    textarea{ min-height:96px; resize:vertical; }
    .btn{ border:1px solid #28405f; background:#0f1726; color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer; transition:.15s; font-weight:600; font-size:12px;}
    .btn:hover{ transform: translateY(-1px); } .btn[disabled]{ opacity:.6; cursor:not-allowed;}
    .btn-primary{ background: linear-gradient(135deg, #1aa27f, #2dd4bf); border:0; color:#072018;} .btn-danger{ background: linear-gradient(135deg, #c2410c, #ef4444); border:0; color:#fff;}
    .btn-soft{ background:#101a2e; border:1px solid #2c3d5d;} .chip{ padding:2px 8px; font-size:11px; border-radius:999px; background:var(--chip); color:#a7b3c8; border:1px solid #2a3a59;}
    #map{ width:100%; height:62vh; border-radius:14px; overflow:hidden; border:1px solid #20314f; background:#0b1220;}
    .table{ width:100%; border-collapse: collapse; font-size:12px; border:1px solid #22304a; border-radius:12px; overflow:hidden;}
    .table th,.table td{ padding:8px 10px; border-bottom:1px solid #22304a;} .table th{ color:#9fb1cc; background:#0f182a; position:sticky; top:0; z-index:1;}
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center;} .errbar{ position:fixed; left:8px; right:8px; bottom:8px; background:#2a1220; border:1px solid #6b273d; color:#ffd0df; padding:8px 10px; border-radius:12px; display:none;}
    .hidden{ display:none !important; } 
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; padding:16px; z-index:9999;}
    .modal.hidden{ display:none !important; }
    details{ background:#0e1626; border:1px solid #22304a; border-radius:10px; padding:8px; }
    details > summary{ cursor:pointer; color:#b7c7e3; }
  </style>
</head>
<body>
  <div class="container">
    <div class="app-title">
      <h2 style="margin:0;">Gesti√≥n de Llamadas</h2>
      <span class="badge">LIVE</span>
      <span class="badge">Single-File</span>
    </div>

    <!-- LOGIN -->
    <section id="login" class="card">
      <h3 class="title">Ingreso</h3>
      <p class="muted">Conecta tus Google Sheets publicados (CSV) desde ‚öôÔ∏è <strong>Configurar</strong>.</p>
      <div class="grid grid-3">
        <div><label>Usuario</label><input id="loginUser" type="text" placeholder="ej: rmejia" autocomplete="username" /></div>
        <div><label>Contrase√±a</label><input id="loginPass" type="password" placeholder="********" autocomplete="current-password" /></div>
        <div class="grid"><label>&nbsp;</label><button id="btnLogin" class="btn btn-primary">Entrar</button></div>
      </div>
      <div class="toolbar" style="margin-top:6px;">
        <span class="chip">Modo: <span id="modeLabel">sheets</span></span>
        <span class="chip">Usuarios: <span id="usersCount">0</span></span>
        <button id="btnOpenConfig" class="btn btn-soft">‚öôÔ∏è Configurar</button>
      </div>
    </section>

    <!-- APP -->
    <section id="app" class="hidden">
      <div class="card">
        <div class="toolbar">
          <button id="btnToggleFiltros" class="btn btn-soft">‚ò∞ Filtros</button>
          <div class="toolbar">
            <button id="btnRegistrar" class="btn btn-soft" disabled>üìù Registrar llamada</button>
            <button id="btnFicha" class="btn btn-soft" disabled>üëÅÔ∏è Ver ficha</button>
            <button id="btnNuevoCliente" class="btn btn-soft">‚ûï Nuevo cliente</button>
            <button id="btnExport" class="btn">‚≠≥ Exportar CSV</button>
            <button id="btnRestaurar" class="btn btn-danger">‚ü≤ Restaurar</button>
            <button id="btnOpenConfig2" class="btn btn-soft">‚öôÔ∏è Configurar</button>
            <button id="btnToggleLegend" class="btn btn-soft">üëÅÔ∏è Mostrar leyenda</button>
            <button id="btnOpenReport" class="btn btn-soft">üìä Reporte</button>
          </div>
          <div class="toolbar">
            <span class="chip">Clientes: <span id="statTotal">0</span></span>
            <span class="chip">Con coordenadas: <span id="statGeo">0</span></span>
            <span class="chip">Filtrados: <span id="statFilt">0</span></span>
          </div>
        </div>

        <div id="panelFiltros" class="card" style="margin-top:8px;">
          <div class="filters">
            <div><label>Semana</label><select id="fSemana"><option value="">Todas</option></select></div>
            <div><label>D√≠a</label><select id="fDia"><option value="">Todos</option></select></div>
            <div><label>Vendedor</label><select id="fVendedor"><option value="">Todos</option></select></div>
            <div><label>Gestor</label><select id="fGestor"><option value="">Todos</option></select></div>
            <div><label>Empresa</label><select id="fEmpresa"><option value="">Todas</option></select></div>
            <div><label>Buscar</label><input id="fBuscar" type="text" placeholder="Nombre o c√≥digo..." /></div>
          </div>
          <div style="margin-top:8px;" class="grid grid-2">
            <div><label>Cliente</label><select id="fCliente"><option value="">-- Seleccione --</option></select></div>
            <div class="toolbar hidden" id="legend"></div>
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="col">
            <div id="map"></div>
            <div class="muted" id="hintZero" style="display:none; margin-top:6px;">No hay clientes con coordenadas en el filtro.</div>
          </div>
          <div class="col card">
            <h3 class="title">Clientes filtrados</h3>
            <div style="max-height:60vh; overflow:auto; border-radius:10px;">
              <table class="table" id="tbl">
                <thead><tr><th>Cod</th><th>Cliente</th><th>Semana</th><th>D√≠a</th><th>Vendedor</th><th>Gestor</th><th>Empresa</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- REPORT -->
  <section id="report" class="hidden">
    <div class="card">
      <div class="toolbar" style="justify-content:space-between;">
        <div class="toolbar">
          <button id="btnBackToApp" class="btn btn-soft">‚üµ Volver</button>
          <h3 class="title">üìà Reporte de llamadas por gestor</h3>
        </div>
      </div>

      <div class="card" style="margin-top:8px;">
        <div class="grid grid-3">
          <div>
            <label>Desde</label>
            <input id="repDesde" type="date"/>
          </div>
          <div>
            <label>Hasta</label>
            <input id="repHasta" type="date"/>
          </div>
          <div>
            <label>Gestor</label>
            <select id="repGestor"><option value="">Todos</option></select>
          </div>
        </div>

        <div class="toolbar" style="margin-top:8px; justify-content:flex-end;">
          <button id="btnRepActualizar" class="btn">Actualizar</button>
        </div>

        <div style="margin-top:8px; max-height:60vh; overflow:auto; border-radius:10px;">
          <table class="table" id="tblRep">
            <thead>
              <tr><th>Gestor</th><th>Total</th><th>Exitosas</th><th>Pendientes/No contesta</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="repDetalle" class="card hidden" style="margin-top:8px;">
          <h4 class="title">Detalle</h4>
          <div style="max-height:50vh; overflow:auto;">
            <table class="table" id="tblRepDetalle">
              <thead>
                <tr><th>Fecha</th><th>Cliente</th><th>Vendedor</th><th>Gestor</th><th>Resultado</th><th>Duraci√≥n (s)</th><th>Obs.</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal Config -->
  <div id="modalConfig" class="modal hidden" aria-modal="true" role="dialog">
    <div class="card" style="width:min(860px,96vw);">
      <h3 class="title">Configuraci√≥n - Conectar Google Sheets</h3>
      <p class="muted">Pega las URL publicadas como CSV de tus hojas. <em>Tip:</em> usa ‚ÄúAplicar ahora‚Äù para ver cambios sin recargar.</p>
      <div class="grid grid-2">
        <div>
          <label>Modo</label>
          <select id="cfgMode"><option value="sheets">sheets (Google)</option><option value="local">local (demo)</option></select>
        </div>
        <div>
          <label>Usuarios (CSV)</label>
          <input id="cfgUsuarios" type="url" placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"/>
        </div>
        <div>
          <label>Clientes (CSV)</label>
          <input id="cfgClientes" type="url" placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"/>
        </div>
        <div>
          <label>Calendario (CSV)</label>
          <input id="cfgCalendario" type="url" placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"/>
        </div>
      </div>
      <details style="margin-top:8px;">
        <summary>Filtros avanzados</summary>
        <div class="grid">
          <div>
            <label>Excluir vendedores (uno por l√≠nea)</label>
            <textarea id="cfgExcluirVendedores" placeholder="Nombres a excluir..."></textarea>
          </div>
        </div>
      </details>
      <div class="toolbar" style="margin-top:8px;">
        <button id="btnCfgProbar" class="btn">Probar conexi√≥n</button>
        <button id="btnCfgGuardar" class="btn btn-primary">Guardar & Recargar</button>
        <button id="btnCfgAplicar" class="btn">Aplicar ahora (sin recargar)</button>
        <button id="btnCfgLimpiar" class="btn btn-danger">Limpiar configuraci√≥n</button>
        <button id="btnCfgCerrar" class="btn btn-soft">Cerrar</button>
      </div>
      <p id="cfgStatus" class="muted" style="margin-top:6px;"></p>
    </div>
  </div>

  <!-- Modal Registrar llamada -->
  <div id="modalRegistrar" class="modal hidden" aria-modal="true" role="dialog">
    <div class="card" style="width:min(980px,96vw);">
      <h3 class="title">üìû Registrar llamada</h3>
      <div class="grid grid-2" style="margin-top:8px;">
        <div>
          <label>Cliente</label>
          <input id="regCliente" type="text" readonly />
        </div>
        <div>
          <label>Cod Empresa</label>
          <input id="regCodEmpresa" type="text" readonly />
        </div>
        <div>
          <label>Vendedor</label>
          <input id="regVendedor" type="text" readonly />
        </div>
        <div>
          <label>gestor_servicio</label>
          <input id="regGestor" type="text" readonly />
        </div>
        <div>
          <label>Fecha y hora</label>
          <input id="regFechaHora" type="datetime-local" />
        </div>
        <div>
          <label>Resultado</label>
          <select id="regResultado">
            <option value="Exitosa">Exitosa</option>
            <option value="No contesta">No contesta</option>
            <option value="Pendiente">Pendiente</option>
            <option value="Rechazada">Rechazada</option>
            <option value="Buz√≥n">Buz√≥n</option>
            <option value="Reprogramada">Reprogramada</option>
          </select>
        </div>
        <div>
          <label>Duraci√≥n (seg.)</label>
          <input id="regDuracion" type="number" min="0" step="1" placeholder="0" />
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Observaciones</label>
        <textarea id="regObs" placeholder="Notas de la llamada..."></textarea>
      </div>

      <details style="margin-top:8px;">
        <summary>Contacto del cliente</summary>
        <div class="grid grid-2" style="margin-top:8px;">
          <div>
            <label>Tel√©fono 1</label>
            <input id="regTelefono1" type="text" readonly />
          </div>
          <div>
            <label>Celular</label>
            <input id="regCelular" type="text" readonly />
          </div>
          <div>
            <label>Provincia</label>
            <input id="regProvincia" type="text" readonly />
          </div>
        </div>
        <div class="grid grid-3" style="margin-top:8px;">
          <div>
            <label>Tipo de cita</label>
            <select id="regCitaTipo">
              <option value="">(sin cita)</option>
              <option value="Cita showroom">Cita showroom</option>
              <option value="Cita externa">Cita externa</option>
            </select>
          </div>
          <div>
            <label>Fecha</label>
            <input id="regCitaFecha" type="date" />
          </div>
          <div>
            <label>Hora</label>
            <input id="regCitaHora" type="time" />
          </div>
        </div>
      </details>

      <div class="toolbar" style="margin-top:12px; justify-content:flex-end;">
        <button id="regCancelar" class="btn btn-soft">Cancelar</button>
        <button id="regGuardar" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>

  <div class="errbar" id="errbar"></div>

<script>
// ======================= CONFIG =======================
const DEFAULT_CONFIG = { 
  mode:'sheets', // forzado a LIVE
  sheets:{usuarios:'', clientes:'', calendario:''},
  excluirVendedores: []
};
let CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG));

// ======================= STATE =======================
const STATE = {
  users: [], clientes: [], calendario: [], joined: [], filtered: [],
  currentUser: null, selected: null,
  map: null, markers: [], colorByVendedor: {}, iconByColor: {}
};

// ======================= UTILS =======================
const JOIN_KEYS = ['Cod Empresa','CodEmpresa','Cod_Empresa','codigo_empresa','codigo','CodEmp','CodEmpresaId'];
function norm(v){ return (v??'').toString().trim().toLowerCase(); }
function stripAccents(s){ return (s??'').toString().normalize('NFD').replace(/[ÃÄ-ÕØ]/g,''); }
function normName(s){ return stripAccents(String(s||'')).trim().toLowerCase(); }

function pick(row, keys){
  for(const k of keys){ if(row && row[k] != null && row[k] !== '') return row[k]; }
  const normRow = {}; for(const key in row){ normRow[key.toLowerCase().replace(/\\s|_/g,'')] = row[key]; }
  for(const k of keys){ const nk = k.toLowerCase().replace(/\\s|_/g,''); if(nk in normRow) return normRow[nk]; }
  return '';
}
function parseCoord(val){
  if(val==null) return NaN;
  const s = String(val).trim();
  let cleaned = s.replace(/[^0-9,\\.\\-]/g, '');
  if(cleaned.includes('.') && cleaned.includes(',')){ cleaned = cleaned.replace(/,/g,''); } else { cleaned = cleaned.replace(',', '.'); }
  const num = parseFloat(cleaned);
  return isFinite(num) ? num : NaN;
}
function getByGuess(row, patterns){
  for(const key in row){ if(patterns.some(rx=> rx.test(key))) return row[key]; }
  const map = {}; for(const k in row){ map[k.toLowerCase().replace(/\\s|_/g,'')] = row[k]; }
  for(const nk in map){ if(patterns.some(rx=> rx.test(nk))) return map[nk]; }
  return '';
}
function getLat(row){ const v = row['Latitud']||row['latitud']||row['LATITUD']||getByGuess(row,[/lat$/i,/^lat/i,/latitude/i]); return parseCoord(v); }
function getLon(row){ const v = row['Longitud']||row['longitud']||row['LONGITUD']||row['Lng']||row['lng']||getByGuess(row,[/lon$/i,/long/i,/lng/i]); return parseCoord(v); }
function uniqueSorted(arr){ return Array.from(new Set(arr.filter(x=>x!=null && x!==' ' && x!==''))).sort((a,b)=>{ const na=Number(a), nb=Number(b); if(isFinite(na)&&isFinite(nb)) return na-nb; return String(a).localeCompare(String(b),'es',{numeric:true}); }); }
function showErr(msg){ const el=document.getElementById('errbar'); el.textContent=msg; el.style.display='block'; setTimeout(()=>{ el.style.display='none'; }, 4200); }
function hashColor(name){ const s=(name||'').toString(); let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h+s.charCodeAt(i); h|=0; } const hue=Math.abs(h)%360; return `hsl(${hue} 80% 55%)`; }
function toDatetimeLocal(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`; }

// ======================= CSV LOADER =======================
async function fetchCSV(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error('HTTP '+res.status);
  const text = await res.text();
  return parseCSV(text);
}
function parseCSV(text){
  const rows = []; const lines = text.split(/\\r?\\n/).filter(x=>x.trim().length>0); if(lines.length===0) return rows;
  const split = (line) => { const result=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const c=line[i], n=line[i+1];
    if(c==='\"'){ if(inQ && n==='\"'){ cur+='\"'; i++; } else inQ=!inQ; } else if(c===',' && !inQ){ result.push(cur); cur=''; } else cur+=c; }
    result.push(cur); return result; };
  const headers = split(lines[0]).map(h=>h.trim());
  for(let i=1;i<lines.length;i++){ const vals = split(lines[i]); const row = {}; headers.forEach((h,idx)=> row[h]= vals[idx]!==undefined ? vals[idx] : '' ); rows.push(row); }
  return rows;
}

// ======================= DATA PREP =======================
function detectVendedor(row){
  const cand = row['Vendedor']||row['VENDEDOR']||row['vendedor']||row['Vendedor Asignado']||row['VENDEDOR ASIGNADO']||row['VendedorAsignado']||row['VENDEDOR_ASIGNADO']||getByGuess(row,[/vendedor/i,/seller/i,/salesrep/i]);
  if(cand && String(cand).trim()!=='') return cand;
  return row['gestor_servicio']||row['Gestor']||row['GESTOR_SERVICIO']||'';
}
function mapUserRecord(r){
  const u = r['Usuario']||r['usuario']||r['Login']||r['NombreUsuario']||r['USUARIO'];
  const p = r['Password']||r['Contrase√±a']||r['Contrasena']||r['PASS']||r['Clave'];
  return { Usuario:(u??'').toString(), Password:(p??'').toString(), gestor_servicio:r['gestor_servicio']||r['Gestor']||r['GESTOR_SERVICIO']||'', Vendedor: detectVendedor(r) };
}

function vendorExcludedSet(){
  const arr = CONFIG.excluirVendedores || [];
  return new Set(arr.map(v=> normName(v) ).filter(Boolean));
}
function isVendorExcluded(name){
  if(!name) return false;
  return vendorExcludedSet().has(normName(name));
}

function buildJoined(){
  const idxCal = {}; const getDia = r => r['Dia'] ?? r['D√≠a'] ?? r['dia'] ?? r['DIA']; const getSem = r => r['Semana'] ?? r['SEMANA'] ?? r['semana'];
  STATE.calendario.forEach(r=>{ const key = norm(pick(r, JOIN_KEYS)); if(!key) return; if(!idxCal[key]) idxCal[key]=r; });
  STATE.joined = STATE.clientes.map(c=>{
    const key = norm(pick(c, JOIN_KEYS)); const m = idxCal[key]; const semana = m ? (getSem(m) || 'Por asignar') : 'Por asignar'; const dia = m ? (getDia(m) || 'Por asignar') : 'Por asignar';
    const lat = getLat(c); const lon = getLon(c);
    const vendedor = detectVendedor(c);
    return { cod: pick(c, JOIN_KEYS) || '', nombre: c['NombreCliente']||c['Cliente']||c['RazonSocial']||c['RAZONSOCIAL']||'', semana, dia,
      vendedor, gestor: c['gestor_servicio']||c['Gestor']||c['GESTOR_SERVICIO']||'', empresa: c['Empresa']||c['EMPRESA']||'', lat, lon };
  });
  if((CONFIG.excluirVendedores||[]).length){
    STATE.joined = STATE.joined.filter(x=> !isVendorExcluded(x.vendedor) );
  }
}

// ======================= UI RENDER =======================
function buildFilters(){
  const S=STATE.joined;
  fillSelect('fSemana', uniqueSorted(S.map(x=>x.semana)), 'Todas');
  fillSelect('fDia', uniqueSorted(S.map(x=>x.dia)), 'Todos');
  const vendOpts = uniqueSorted(S.map(x=>x.vendedor)).filter(v=> !isVendorExcluded(v) );
  fillSelect('fVendedor', vendOpts, 'Todos');
  fillSelect('fGestor', uniqueSorted(S.map(x=>x.gestor)), 'Todos');
  fillSelect('fEmpresa', uniqueSorted(S.map(x=>x.empresa)), 'Todas');
  const opts = S.map(x=>({value:x.cod, label:`${x.cod} - ${x.nombre}`})).sort((a,b)=>a.label.localeCompare(b.label,'es',{numeric:true}));
  const sel = document.getElementById('fCliente'); sel.innerHTML = '<option value="">-- Seleccione --</option>' + opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
  buildLegend();
}
function fillSelect(id, arr, defLabel){ const el=document.getElementById(id); el.innerHTML = `<option value="">${defLabel}</option>` + arr.map(v=>`<option value="${String(v)}">${String(v)}</option>`).join(''); }
function buildLegend(){
  const legend=document.getElementById('legend'); legend.innerHTML='';
  uniqueSorted(STATE.joined.map(x=>x.vendedor))
    .filter(v=> !isVendorExcluded(v))
    .forEach(v=>{ const c=hashColor(v||''); const span=document.createElement('span'); span.className='chip'; span.style.borderColor=c; span.style.color='#dbe7ff'; span.textContent=v||'Sin vendedor'; legend.appendChild(span); });
}
function applyFilters(){
  const fSemana=val('fSemana'), fDia=val('fDia'), fVend=val('fVendedor'), fGes=val('fGestor'), fEmp=val('fEmpresa'), fBus=norm(val('fBuscar')), fCli=val('fCliente');
  STATE.filtered = STATE.joined.filter(x=>{
    if(isVendorExcluded(x.vendedor)) return false;
    if(fSemana && String(x.semana)!==String(fSemana)) return false; if(fDia && String(x.dia)!==String(fDia)) return false;
    if(fVend && String(x.vendedor)!==String(fVend)) return false; if(fGes && String(x.gestor)!==String(fGes)) return false;
    if(fEmp && String(x.empresa)!==String(fEmp)) return false; if(fCli && String(x.cod)!==String(fCli)) return false;
    if(fBus){ const hay=[x.cod,x.nombre,x.vendedor,x.gestor,x.empresa].map(v=>norm(v)).some(s=>s.includes(fBus)); if(!hay) return false; }
    return true;
  });
  renderTable(); renderMap(); updateStats(); updateButtonsState();
}
function val(id){ return document.getElementById(id).value; }
function renderTable(){
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
  STATE.filtered.forEach(x=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.cod}</td><td>${x.nombre}</td><td>${x.semana}</td><td>${x.dia}</td><td>${x.vendedor}</td><td>${x.gestor}</td><td>${x.empresa}</td>`; tr.style.cursor='pointer'; tr.onclick=()=>selectCliente(x); tb.appendChild(tr); });
}

// ===== Map with PIN icons =====
function initMap(){
  if(STATE.map) return;
  const RD=[18.735693,-70.162651]; STATE.map=L.map('map',{zoomControl:true}).setView(RD,8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(STATE.map);
  setTimeout(()=>STATE.map.invalidateSize(), 200); window.addEventListener('resize', ()=>STATE.map&&STATE.map.invalidateSize());
}
function clearMarkers(){ STATE.markers.forEach(m=>STATE.map.removeLayer(m)); STATE.markers=[]; }
function getVendedorColor(v){ if(!v) return '#9aa3b2'; if(!STATE.colorByVendedor[v]) STATE.colorByVendedor[v]=hashColor(v); return STATE.colorByVendedor[v]; }

function svgPin(color){
  const fill = color || '#3b82f6';
  const stroke = '#08121f';
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="26" height="38" viewBox="0 0 26 38">
    <path d="M13 0C7 0 2 5 2 11c0 7.5 9 17 11 19 2-2 11-11.5 11-19C24 5 19 0 13 0z" fill="${fill}" stroke="${stroke}" stroke-width="2"/>
    <circle cx="13" cy="12" r="4.2" fill="#fff" stroke="${stroke}" stroke-width="2"/>
  </svg>`;
  return 'data:image/svg+xml;base64,' + btoa(svg);
}
function pinIcon(color){
  if(!STATE.iconByColor[color]){
    STATE.iconByColor[color] = L.icon({
      iconUrl: svgPin(color),
      iconSize: [26, 38],
      iconAnchor: [13, 36],
      popupAnchor: [0, -30],
      className: 'vendor-pin'
    });
  }
  return STATE.iconByColor[color];
}

function renderMap(){
  initMap(); clearMarkers(); const bounds=[]; let rendered=0;
  STATE.filtered.forEach(x=>{
    if(!isFinite(x.lat)||!isFinite(x.lon)) return; 
    const color=getVendedorColor(x.vendedor);
    const m=L.marker([x.lat,x.lon],{ icon: pinIcon(color) }).addTo(STATE.map);
    m.bindPopup(`<strong>${x.nombre}</strong><div class="muted">Cod ${x.cod} ‚Ä¢ ${x.empresa||''}</div><div>Semana: ${x.semana} ‚Ä¢ D√≠a: ${x.dia}</div><div>Vendedor: ${x.vendedor||'-'} ‚Ä¢ Gestor: ${x.gestor||'-'}</div>`);
    m.on('click',()=>selectCliente(x)); STATE.markers.push(m); bounds.push([x.lat,x.lon]); rendered++;
  });
  document.getElementById('hintZero').style.display = rendered? 'none':'block';
  if(bounds.length){ STATE.map.fitBounds(bounds,{padding:[20,20]}); } else { STATE.map.setView([18.735693,-70.162651],8); }
  setTimeout(()=>STATE.map.invalidateSize(), 50);
}
function selectCliente(x){ STATE.selected=x; document.getElementById('fCliente').value=x.cod; renderMap(); updateButtonsState(); }
function updateButtonsState(){ const has=!!STATE.selected; document.getElementById('btnRegistrar').toggleAttribute('disabled', !has); document.getElementById('btnFicha').toggleAttribute('disabled', !has); }
function updateStats(){ const t=STATE.joined.length, g=STATE.joined.filter(x=>isFinite(x.lat)&&isFinite(x.lon)).length, f=STATE.filtered.length; document.getElementById('statTotal').textContent=t; document.getElementById('statGeo').textContent=g; document.getElementById('statFilt').textContent=f; }
function exportCSV(){ const headers=['Cod','Cliente','Semana','Dia','Vendedor','Gestor','Empresa','Latitud','Longitud']; const rows=STATE.filtered.map(x=>[x.cod,x.nombre,x.semana,x.dia,x.vendedor,x.gestor,x.empresa,x.lat||'',x.lon||'']); const csv=[headers.join(','),...rows.map(r=>r.map(csvEscape).join(','))].join('\\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='clientes_filtrados.csv'; a.click(); URL.revokeObjectURL(a.href); }
function csvEscape(v){ if(v==null) return ''; const s=String(v); return (s.includes(',')||s.includes('\"')||s.includes('\\n'))?('\"'+s.replace(/\"/g,'\"\"')+'\"'):s; }

// ======================= REPORT =======================
function parseDateISO(s){
  if(!s) return null;
  const [y,m,d] = s.split('-').map(n=>parseInt(n,10));
  if(!y||!m||!d) return null;
  return new Date(y, m-1, d, 0,0,0);
}
function loadSavedCalls(){
  try{ return JSON.parse(localStorage.getItem('llamadas_records')||'[]'); }catch(_){ return []; }
}
function saveCalls(arr){
  try{ localStorage.setItem('llamadas_records', JSON.stringify(arr)); }
  catch(e){ showErr('No se pudo guardar el registro.'); }
}
function openReport(){
  STATE.calls = loadSavedCalls();
  const sel = document.getElementById('repGestor');
  const gestores = Array.from(new Set(STATE.calls.map(r=>r.gestor_servicio||'').filter(Boolean)))
    .sort((a,b)=>a.localeCompare(b,'es',{numeric:true}));
  sel.innerHTML = '<option value="">Todos</option>' + gestores.map(g=>`<option value="${g}">${g}</option>`).join('');
  document.getElementById('app').classList.add('hidden');
  document.getElementById('report').classList.remove('hidden');
  renderReporte();
}
function closeReport(){
  document.getElementById('report').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
}
function renderReporte(){
  STATE.calls = loadSavedCalls();
  const desde = parseDateISO(document.getElementById('repDesde').value);
  const hastaRaw = parseDateISO(document.getElementById('repHasta').value);
  const hasta = hastaRaw ? new Date(hastaRaw.getFullYear(), hastaRaw.getMonth(), hastaRaw.getDate(), 23,59,59) : null;
  const gestorSel = document.getElementById('repGestor').value;

  const data = STATE.calls.filter(r=>{
    const dt = r.fecha_hora ? new Date(r.fecha_hora) : null;
    if(desde && dt && dt < desde) return false;
    if(hasta && dt && dt > hasta) return false;
    if(gestorSel && (r.gestor_servicio||'') !== gestorSel) return false;
    return true;
  });

  const agg = {};
  data.forEach(r=>{
    const g = r.gestor_servicio || 'NO ASIGNADO';
    if(!agg[g]) agg[g] = { gestor:g, total:0, exitosas:0, pendientes:0, rows:[] };
    agg[g].total++;
    if((r.resultado||'').toLowerCase() === 'exitosa') agg[g].exitosas++; else agg[g].pendientes++;
    agg[g].rows.push(r);
  });

  const rows = Object.values(agg).sort((a,b)=>a.gestor.localeCompare(b.gestor,'es',{numeric:true}));
  const tb = document.querySelector('#tblRep tbody'); tb.innerHTML='';
  rows.forEach(g=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td style="cursor:pointer; text-decoration:underline;">${g.gestor}</td><td>${g.total}</td><td>${g.exitosas}</td><td>${g.pendientes}</td>`;
    tr.addEventListener('click', ()=> renderDetalle(g.rows));
    tb.appendChild(tr);
  });
  if(rows.length===0){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="4" class="muted">Sin datos</td>'; tb.appendChild(tr); }

  document.getElementById('repDetalle').classList.add('hidden');
  document.querySelector('#tblRepDetalle tbody').innerHTML='';
}
function renderDetalle(rows){
  const tb=document.querySelector('#tblRepDetalle tbody'); tb.innerHTML='';
  rows.sort((a,b)=> new Date(b.fecha_hora) - new Date(a.fecha_hora));
  rows.forEach(r=>{
    const fecha = r.fecha_hora ? new Date(r.fecha_hora).toLocaleString() : '';
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${fecha}</td><td>${r.cliente||''}</td><td>${r.vendedor||''}</td><td>${r.gestor_servicio||''}</td><td>${r.resultado||''}</td><td>${r.duracion_seg||0}</td><td>${(r.observaciones||'').replace(/</g,'&lt;')}</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('repDetalle').classList.remove('hidden');
}

// ======================= REGISTRAR LLAMADA =======================
function getClienteRowByCod(cod){
  const target = String(cod||'');
  for(const r of STATE.clientes){
    const rcod = pick(r, JOIN_KEYS);
    if(String(rcod) === target) return r;
  }
  return null;
}
function openRegistrarModal(){
  if(!STATE.selected){ showErr('Seleccione un cliente para registrar.'); return; }
  const s = STATE.selected;
  const row = getClienteRowByCod(s.cod) || {};
  document.getElementById('regCliente').value = s.nombre || '';
  document.getElementById('regCodEmpresa').value = s.cod || '';
  document.getElementById('regVendedor').value = s.vendedor || '';
  document.getElementById('regGestor').value = s.gestor || '';
  document.getElementById('regFechaHora').value = toDatetimeLocal(new Date());
  document.getElementById('regResultado').value = 'Exitosa';
  document.getElementById('regDuracion').value = '';
  document.getElementById('regObs').value = '';

  document.getElementById('regTelefono1').value = row['Telefono1'] || row['telefono1'] || '';
  document.getElementById('regCelular').value   = row['Celular']   || row['celular']   || '';
  document.getElementById('regProvincia').value = row['Provincia'] || row['provincia'] || '';
  document.getElementById('regCitaTipo').value = '';
  document.getElementById('regCitaFecha').value = '';
  document.getElementById('regCitaHora').value = '';

  const m=document.getElementById('modalRegistrar'); m.classList.remove('hidden'); m.style.display='flex';
}
function closeRegistrarModal(){
  const m=document.getElementById('modalRegistrar'); m.classList.add('hidden'); m.style.display='none';
}
function saveRegistro(){
  if(!STATE.selected){ showErr('No hay cliente seleccionado.'); return; }
  const s = STATE.selected;
  const row = getClienteRowByCod(s.cod) || {};
  const rec = {
    id: Date.now(),
    cod_empresa: s.cod || '',
    empresa: s.empresa || '',
    cliente: s.nombre || '',
    vendedor: s.vendedor || '',
    gestor_servicio: s.gestor || '',
    fecha_hora: (document.getElementById('regFechaHora').value || new Date().toISOString()),
    resultado: document.getElementById('regResultado').value || '',
    duracion_seg: parseInt(document.getElementById('regDuracion').value||'0',10) || 0,
    observaciones: document.getElementById('regObs').value || '',

    telefono1: row['Telefono1'] || row['telefono1'] || '',
    celular:   row['Celular']   || row['celular']   || '',
    provincia: row['Provincia'] || row['provincia'] || '',

    cita_tipo:  document.getElementById('regCitaTipo').value || '',
    cita_fecha: document.getElementById('regCitaFecha').value || '',
    cita_hora:  document.getElementById('regCitaHora').value || ''
  };
  const calls = loadSavedCalls(); calls.push(rec); saveCalls(calls);
  closeRegistrarModal();
  showErr('‚úÖ Llamada registrada.');
}

// ======================= LOGIN =======================
function doLogin(){
  const u=val('loginUser').trim(), p=val('loginPass'); 
  if(!u||!p){ showErr('Ingrese usuario y contrase√±a.'); return; }
  const ok=STATE.users.find(x=> norm(x.Usuario)===norm(u) && String(x.Password)===String(p) );
  if(!ok){ showErr('Usuario o contrase√±a incorrectos.'); return; }
  document.getElementById('login').classList.add('hidden'); 
  document.getElementById('app').classList.remove('hidden'); 
  setTimeout(()=>STATE.map&&STATE.map.invalidateSize(), 50); 
  applyFilters();
}

// ======================= CONFIG MODAL =======================
function openConfig(){
  document.getElementById('cfgMode').value = CONFIG.mode;
  document.getElementById('cfgUsuarios').value = CONFIG.sheets.usuarios || '';
  document.getElementById('cfgClientes').value = CONFIG.sheets.clientes || '';
  document.getElementById('cfgCalendario').value = CONFIG.sheets.calendario || '';
  document.getElementById('cfgExcluirVendedores').value = (CONFIG.excluirVendedores||[]).join('\\n');
  document.getElementById('cfgStatus').textContent = '';
  const m=document.getElementById('modalConfig'); m.classList.remove('hidden'); m.style.display='flex';
}
function closeConfig(){ const m=document.getElementById('modalConfig'); m.classList.add('hidden'); m.style.display='none'; }
async function testConfig(){
  const u=val('cfgUsuarios').trim(), c=val('cfgClientes').trim(), k=val('cfgCalendario').trim(); const out=[];
  async function tryFetch(name, url){ if(!url){ out.push(`${name}: (vac√≠o)`); return; } try{ const arr=await fetchCSV(url); out.push(`${name}: OK (${arr.length} filas)`); }catch(e){ out.push(`${name}: ERROR (${e.message})`); } }
  await tryFetch('Usuarios',u); await tryFetch('Clientes',c); await tryFetch('Calendario',k); document.getElementById('cfgStatus').textContent = out.join(' ‚Ä¢ ');
}
function parseExcludeTextarea(){
  const raw = document.getElementById('cfgExcluirVendedores').value || '';
  return raw.split(/[\\r\\n]+/).map(s=>s.trim()).filter(Boolean);
}
function saveToLocalStorage(cfg){
  try{ localStorage.setItem('llamadas_config', JSON.stringify(cfg)); return true; }catch(e){ console.error(e); showErr('No se pudo guardar configuraci√≥n (localStorage).'); return false; }
}
function forceReload(){ try{ location.reload(); }catch(_){ try{ window.location.assign(window.location.pathname + '?r=' + Date.now()); }catch(__){} } }
function saveConfig(){
  const modeSel = val('cfgMode');
  const usuarios = val('cfgUsuarios').trim();
  const clientes = val('cfgClientes').trim();
  const calendario = val('cfgCalendario').trim();
  const mode = modeSel; // respetar selecci√≥n expl√≠cita
  const excluirVendedores = parseExcludeTextarea();
  const cfg = { mode, sheets:{ usuarios, clientes, calendario }, excluirVendedores };
  if(saveToLocalStorage(cfg)){
    const s=document.getElementById('cfgStatus'); s.textContent='Configuraci√≥n guardada. Recargando...';
    document.getElementById('btnCfgGuardar').disabled=true; document.getElementById('btnCfgProbar').disabled=true; document.getElementById('btnCfgAplicar').disabled=true;
    setTimeout(()=>{ closeConfig(); forceReload(); }, 350);
  }
}
async function applyConfigNow(){
  const usuarios = val('cfgUsuarios').trim(), clientes = val('cfgClientes').trim(), calendario = val('cfgCalendario').trim();
  const excluirVendedores = parseExcludeTextarea();
  const cfg = { mode: 'sheets', sheets:{usuarios, clientes, calendario}, excluirVendedores };
  saveToLocalStorage(cfg);
  document.getElementById('cfgStatus').textContent = 'Aplicando configuraci√≥n... cargando datos';
  try{
    STATE.users = (await fetchCSV(usuarios)).map(mapUserRecord);
    STATE.clientes = await fetchCSV(clientes);
    STATE.calendario = await fetchCSV(calendario);
    CONFIG = cfg;
    document.getElementById('modeLabel').textContent = CONFIG.mode;
    document.getElementById('usersCount').textContent = STATE.users.length;
    buildJoined(); buildFilters(); applyFilters();
    document.getElementById('cfgStatus').textContent = 'Listo. Puedes cerrar esta ventana.';
  }catch(err){
    document.getElementById('cfgStatus').textContent = 'Error cargando datos: ' + err.message;
  }
}
function clearConfig(){ try{ localStorage.removeItem('llamadas_config'); }catch(_){ } forceReload(); }

// Keyboard: ESC para cerrar modales
document.addEventListener('keydown', (e)=>{ 
  if(e.key==='Escape'){ 
    closeConfig(); 
    closeRegistrarModal();
  } 
});

// Toggle legend
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id==='btnToggleLegend'){
    const el = document.getElementById('legend');
    const isHidden = el.classList.contains('hidden');
    el.classList.toggle('hidden');
    e.target.textContent = isHidden ? 'üëÅÔ∏è Ocultar leyenda' : 'üëÅÔ∏è Mostrar leyenda';
  }
});

// ======================= INIT =======================
async function init(){
  // Load saved config
  try{
    const saved = JSON.parse(localStorage.getItem('llamadas_config')||'null');
    if(saved && typeof saved==='object'){
      CONFIG = Object.assign({}, DEFAULT_CONFIG, saved);
      CONFIG.sheets = Object.assign({}, DEFAULT_CONFIG.sheets, saved.sheets||{});
      CONFIG.excluirVendedores = Array.isArray(saved.excluirVendedores) ? saved.excluirVendedores : DEFAULT_CONFIG.excluirVendedores;
    }
  }catch(_){}
  document.getElementById('modeLabel').textContent = CONFIG.mode;

  // LIVE ONLY: cargar solo desde Sheets si hay URLs
  if(CONFIG.mode==='sheets'){
    const hasURLs = CONFIG.sheets.usuarios && CONFIG.sheets.clientes && CONFIG.sheets.calendario;
    if(!hasURLs){
      showErr('Faltan URLs CSV: configura Usuarios, Clientes y Calendario.');
    }else{
      try{
        STATE.users = (await fetchCSV(CONFIG.sheets.usuarios)).map(mapUserRecord);
        STATE.clientes = await fetchCSV(CONFIG.sheets.clientes);
        STATE.calendario = await fetchCSV(CONFIG.sheets.calendario);
      }catch(err){
        console.error(err);
        showErr('Error cargando hojas: ' + err.message + ' (revisa permisos Publicar como CSV)');
      }
    }
  }
  document.getElementById('usersCount').textContent = STATE.users.length;

  // Render b√°sico (aunque no haya datos todav√≠a)
  buildJoined(); buildFilters(); updateStats(); applyFilters();

  // Events
  document.getElementById('btnLogin').addEventListener('click', doLogin);
  ['fSemana','fDia','fVendedor','fGestor','fEmpresa'].forEach(id=> document.getElementById(id).addEventListener('change', applyFilters));
  document.getElementById('fBuscar').addEventListener('input', applyFilters);
  document.getElementById('fCliente').addEventListener('change', ()=>{ const cod=val('fCliente'); const x=STATE.joined.find(r=> String(r.cod)===String(cod) ); if(x){ selectCliente(x); } else { STATE.selected=null; updateButtonsState(); } });
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('btnRestaurar').addEventListener('click', ()=>{ ['fSemana','fDia','fVendedor','fGestor','fEmpresa'].forEach(id=> document.getElementById(id).value=''); document.getElementById('fBuscar').value=''; document.getElementById('fCliente').value=''; STATE.selected=null; applyFilters(); });
  document.getElementById('btnToggleFiltros').addEventListener('click', ()=>{ const p=document.getElementById('panelFiltros'); p.style.display=(p.style.display==='none')?'block':'none'; setTimeout(()=>STATE.map&&STATE.map.invalidateSize(),50); });

  // Report events
  document.getElementById('btnOpenReport').addEventListener('click', openReport);
  document.getElementById('btnBackToApp').addEventListener('click', closeReport);
  document.getElementById('btnRepActualizar').addEventListener('click', renderReporte);

  // Config modal
  document.getElementById('btnOpenConfig').addEventListener('click', openConfig);
  document.getElementById('btnOpenConfig2').addEventListener('click', openConfig);
  document.getElementById('btnCfgCerrar').addEventListener('click', closeConfig);
  document.getElementById('btnCfgProbar').addEventListener('click', testConfig);
  document.getElementById('btnCfgGuardar').addEventListener('click', saveConfig);
  document.getElementById('btnCfgAplicar').addEventListener('click', applyConfigNow);
  document.getElementById('btnCfgLimpiar').addEventListener('click', clearConfig);

  // Registrar llamada events
  document.getElementById('btnRegistrar').addEventListener('click', openRegistrarModal);
  document.getElementById('regCancelar').addEventListener('click', closeRegistrarModal);
  document.getElementById('regGuardar').addEventListener('click', saveRegistro);
}
window.addEventListener('DOMContentLoaded', ()=>{ 
  init(); 
  initMap(); 
});
</script>
</body>
</html>
