<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM de Llamadas — v7.1</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --rd-lat: 18.7357; --rd-lon: -70.1627; }
    body { background: #f7fafc; }
    .card { border-radius: 1rem; box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
    .btn { border-radius: .75rem; }
    .pill { border-radius:9999px; padding:.15rem .6rem; font-size:.75rem; }
    .navbtn { padding:.5rem 1rem; border-radius:.75rem; background:#e5e7eb; }
    .navbtn.active { background:#111827; color:#fff; }
    #map { min-height: 420px; }
    .modal-bg { background: rgba(0,0,0,.45); z-index:60; }
    header { position: sticky; top: 0; z-index: 50; }
  </style>
</head>
<body class="text-gray-900">
  <!-- Navbar -->
  <header class="bg-white shadow p-3">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANgAAABbCAMAAAAm2rupAAACfFBMVEX////dEyHuiZDlTVj2xMf74eP509X98PHfIi/qbHXwmJ7hMT3yp6zjP0vse4P0trroXWf//wD/8gD/+AD/7gD/+QDWACTlQiD/5wD0eSD//fPYCSExX9XjOSDwcx9JbL/eICCOm3j/9eD7t1TnSyDqWh/iMiP2lBj3gyL/3Jb2ihv/9NntZB8AAADubR//8ND8xWkAXS3/7sY4Y9D91ItCasVQc7fKyzj05Q2bpGr+3J47Zcvr3hZkfqNMb7v5oi7Fvz3vHST+9ej9z371kzf+46372wf93Kf8xG72ugzzpg/0bwz6rUD2jwrJpjzGADnCdUF8Vo1PgLvSbzH7sBH9zAvs/xV0oZNbe62psVvg1SKwtlNrg5mCk4X3nhX6hBrQkSuVfI67waf+/E+zpADRhAurfGWyw+jM3Oucn652dX6IhFrb12D/+XPd2qugXj6RdFt3mNa6urN8eXSXk4wlJi9UV3G3clOfmFjY1tKjvvFBPzw6SlV8VTmkc1xYa404VYfacBVykcWAkK9VWlyPNwDj7Pult8q1flGoo5aLw/KSmaBBT2rzn2DRWg3KnnrUucDHbo/0AAfxPwbYpL6oVRyzKg+jcHfdOQCGg7mff0DCICT/ZAOka4SvXhNZExOIFhlnEhNCDhDJTk24O1HB5Pt2su++rslGYypubSakfnmpvv1rjpnssp2uu3q3xtyqdCOJjx5CYyoAVDG+j07evijG1QqLsRMgdCZ/aBjCTS+tIVONYShOfJOZ6/99VlhsaZz/0LK9IETgRWSbM2hZWq3eqCSvUVSCexUDGTQ9SwC+ciOxjx8tTZ4gN3IlMQNelB+lewuoyxGk2Q/C7A9LAAASF0lEQVR4nN1ci3tTx5XX6C3LtixLyL6+SLq29UIIY4wtv5GvDcKyRJb6EWxZlpIGaif7goR2N95uGkMRaWgINY+m6+zWTWETWLemzULXKbtl04amDd12s//Qzr26dx73YbNJvnXdw/eB7535zZzfzDlnzswdYzBoyt6+PR1N2kU7WVpGDifCsfaO7dbji5YjqRDLcWxD9Mh2a/LFykg8wkbT6SjL/UkwOzra2to6OtLZ2c4ANuP2eNxjPn9q/3ar9XmlpZUJ+SP+hlA4HAK+MXdjY6PXnfWFcnu3W7PPJy25MMuyEX+EA6yPP+ZpFIk99WcgnNvRwXG4FfIKRYuxGBPLHP9Sj7u+vt7j7R2f4NlQrHVPy3br95mlvU3gNVlkoEw9fWJ6pjvfPTsY7HZHWR/rb8v1bbeCn1H6YoANMfGxOOQVyGYaZwvTyUPJuQF3ejIcaoiwkdjIdqv4maQl52fDsVgR8gqUis88++XnPPnu7oGek6eYABOLxcKAi+3ZbiU/i/QF4IoFvSsab2NKX5lfeP6FP/+L5577y78q/HWWiQl/2thIaidGx/YQy4zBySllmeLpMy++dPbsV78GXz//wqWJbJGJTgZiYV+ic7u1/L9LU2uEm4xGS/G/mTj2t2fWz75sWLS9DN9/9e++/veQarQYZRgQye28qD+ci0QyxWjpK4cGXzm0YDCsf+PVBeH9y4bCvqVodHIMrgIN4PDOs8WmVj83ViwxD+fP/e6cYWH+/L5vLwrvF87Mf/NCfCwajcZiITZGpvpWsyg26lEutJglEZ9s1JMaK2FcRihmK/zRjMUqN0ZCLao6YlE1xFeJhVjaw2w4no2fn0+Or68vlF/Y9+rrFoth4fzXzl987e3sZDEQjUMvJPJhmx2IUis9m8QnudQIJBH7rJafdLDCK6NTrmQ0GAAWk9yYkehH+JmuAxuwEw1g2RNgQZg59q3Fc/ML6/OvX/r6udpIQ9WtS3Dmmt64nC3GizE/IGdMVta+ObEq4alOQUyJNRhcSCtdYqB6M2K2GqoBLHtTfph4HHtzcRz61pXvnH/dvLx8dfnapX3n5xcMZ69n41GG46KEj6GGqjclViM8Ia11sHhKNyNWqa1DzEQ3QEh7GLAgsTSdnDdcunHVuWBz8sv8tYWLi+WFW+vXSzEm7GtoxVHRLDYotapDTNTfUqlbQxSrsOaKQnYH9BGHUyZWI/uPTMxuVRGT69gqFUTfq60iecHowQI2PFk4lCx/962s02awuaqt84vf+956eeHFU9FYgGPbiHXMITRkBZLq2sRqpWEW/nUQxTrYOimW2CSlTarpF5jRxOQ6ZkxMIU2tDWxxKu3pDSYXrDzvqDKZamEgMvJOq6H8D5NMLMFGonjHaRHacVacx7gpsbqK5RlxsQorvgBOIkZWXghB0mghiAG7TUEM1ZEqOFwqZtAU0+7G+tn+8bLBtLxyYxlKnaXm7bf+sbz+T/EYw7GBdly7onjFN5x6xIyi/dkEvesIYipsxcOIEEn6j1m2azFq1ti0fMxcsQqJKr2IGDoT3JTXmy+MnysbrMvc999ZXeG4GvvyjRfnX4uVEhwbzg3j2mIvLmmsXXrEqsRSQe9qgpgKS4VzPWImqxiCTDrEMDPgtFLERsJc2jPwrcWF9XPz5aplfuUH77zzA27Zbr41fT0BI2aYPPoQx1gI1uKc1OkRE3V3CDZnwcTUWOOTzJhJDjE6xAxmB2JGzllHlPNPefLny+Vy8tA5wy9uLPM8DIsO28L4wg85FrTlyKyDDK6gEgK0iIm6m5xC0MfE1FjJ85U+ViNnJxIxYlEwqupUxltqu5pQFWYeidKxzKWywXCuq2vB8NL3V1ecN6+Vb525BQ3KH28l00QrrZvYjyYx2e1rMTEtbGWdc1ayJqtZMyoKT1UqYrhOhZwTFUvSkuJAgMlmnzWUy+u9J2AAKb/48mLXP996t9rEcW0pesPioHUTQ0CFmFGKUhIxmYUVE9PCygo7TSaTHS3QlYhnJIghsCIqCgi7o9psrq4MEREa98a5lfduM9k70BQX7k2dPgPf/cvamz/6kZ3nuHg7fbJYSfUqVuCQWyItzCwTk0bQbkDENLE0WzrzACQxuaLCxwD9VEPo2pLiVw68x2RfWV84cz6QLf54fv3LT42lJ49lQxzLHKV4SQNcRVhlnR6xSqxyYGKaWHKp2pyYlBJuSqyGjIrDOb/v9l0mOzE9HnwlO1bf030vXT+VaWyMMrFIQzvFS5oGaZW3Sw/axCq6uzAxTSwUS62c3de4NiEmMVMTc8hwUzWla0sqwk/c3li6/eCV49lU/ezMrvRUfX06nUlAYv6c4f9FiK3VFwbviLH+nxz46caBjVL27TuFg83uqcxUPO1pnIz52cTo51F3e6Uz4Ut4H088eP9AWzTzVNfuufxa4V+PlcYyxbAvsoO/SsDc3sd4jyWe+clG1OvxDswUgrvHu92ZRJhj2UT71g38scr+w4ALpDOl9NSdmYGeek/9wMzcvampxkwM7tL8qT0d+/fvzLP7Pob1M8XM5L1CMJhcm8lDbp7GeACm+5Mw/Y0kAkzs8Ojw1u380UlngA0xTPGZ5MH+YDDYBbl197in2tI99392N3uVF4RLtO68U0XDHgZuI9Pege6h3rVksKurvytZmJkqPf63A+9vlD75oObmd24CLr4Dv7PvP8z5Eh6vt77e25OH5KaDXR/9vKEUeHDgwOmHF9enL956F4C2PphfSFJZBW3yo6kOt+VALx1kFyZKjC7FdhBKrTZQfq3fpQ5QkKbWEPige6BHoCaS6z7t5NkHp9pe+vfkYrl8/jWDg+NiR/ByX8mf8T6C2ExRCYHma1HsDuUBhQ5QTmkqXbpQHYcWUDVcfQH+ZnJ6rXlmKA/p1de7JwG/8v7Gu7fgNubKs/Pr1TwXEHyMJobOCwFWktgOAjPRg5IYpEafT+gBaWI4XUZJhlUHKEpHjHd29ff3dwWTg3O9QwPuNAdubJydP7e+vvjs5Tv/cY33p1oMSmKoPSKfJtNZ8hxMTUyhRpUOkCaGjihrNIH0kSKUIwwAp9cGk8F+QYKDvd1+Lv7G/PPH5+/84szzV67UgfAoqZ7YADYLIvGsI7ohTV6LGLlppoCEy9LEcJeYu0MHKEpn2NfQ6B3ID800F6YPdR08+JDj/rOcPL60ePzy/K1ry5w/elRFDLVIKkicVUvnV/rEqAF26gApYpiEbUugIMKp4uWBRi/MOeph0J/tXfuQ52quvFZ6M7lUujhv4kKpPko9I8WBmBkLpbjyGEMp9icAUsQ0urTpAUViuQj/4XRhrndWCB71Hrf3Kgs459GW8sU3Oox2EM4dodUTesFmQfgKdQpPFmgSIyq49IAkMRwnXDpAxYHpcCoC+C+J7pUcFGLj/UcsrPXLXzprq+s4LlSU12aSGD7uIlqqpbohTE2bmHFrIEkMH4vicqMeUJTRBMvfHJxOCu61e/fu/mCB40Hkrbc4KIF4Cp0NkHhk22QMkz6kSCZD+LJc2WE2V2E/xBZlooAmg7KA7lJNXA0UZW/K72vz5PNDQzO9zXOFweSveMBFW1NMhGtrPYIze6JhbBbkSiuXqwaWVMmKmJl0gITzEcQ0u9QFiiJsyMbcQuyA0cPr7elpAyxMNZpGovFWMqsn1ENmQYZYM90NoQA11ghr2hpIEDOqYJisGihKy+EI+PUJMe/ogYmVd5c3DHeYI3Aq6d0zoR4yC9JfpeZN1aoyihjKMpCG0iprcqmABDHVB0MMrHGpi0RiMHr4Ptrdn5wurM0JcuI0AAH19SmsHjILavKlVdaBJuBJiekDMTG0IpBdSiGsTgaSnwCgNLUHAIweyS4hdIjyK15rn4LVQ4kM1ZLkPEZ5cVH5kIIYMmOnLhATQ12SGY0MNKiAFWnJNbBhT75bCB7Nzb2z3WEAEu2qrSVWD5kFadTymJplhnYNpIFYe4x6QJzgY2KoS+KQTR4IF3INhcbCp9rL9xvFbYsgnvyK1tYSKYTMgjxPRsszPj+1qJDCA1oCZVdyqYBIeURMs0sXqq4CysRCwP5wHCYfM4I0F5I3eTamuueM1ENmQTmrHO3wT9UqpIFMn2xbAxExlNSQ66YRAY1KoCSdDOA/RD7WNdhsB2xIdcyB1JO7oxJ02VhMeC9Rq0LCCI1sCjmLCc2FCoiIofSf7BIDq5VtSjKcCrH8o/tDs0OC5HvcJZhUxZS2KLeNFiKHVrEDhweTEuk0Edm4WVFapwFExDS7VAMp3xCkL86xRbdHkF27PI099+CUtSlvlcqNozGn9opErEY5txJJSu2TAGViqEty3bRuAkTS3gZW5k7MwZjYPLdWSH7EcqxfeV9WpRuVTcuDKrCVo5tVDylcAZCBVURrdqIRkhgS0ok2AyJpyYX4n8Mk+KB4QlB4hQcwrTqsnXmg4aO2rLIX4G/S2NPVvEw2FdCqAVTNGLlSOTYBYmlvY/lfN/fOzA5153s8u4qc2svkxvFOllzGyDVI9kKHAimLkxx45yZAWV+8r7FsDlQdDxyNcYB92y0kwsLR6eyPv8sDwNBpldy2UWvPIkdxcUhlI6lRING4W9XAGi0gCh5oynC6ZdMCKo8HDDk/3DUfF3ct08lg/8GDH/E866dvOKO2tbZ8VMBFWZMOscqVr4rIq2wdBbQpiGl0uSkQEwuxXGDpYfDQoWRyfHBtrvepq4Bl26hL6YgY3hphX5V7Fj7+m5RxU0WMWAI3BSJiGucCxs2ASI5GQ2yotHRvYKBH+K0WaI5nnUCPGN614GWFuAtJSJUeMdXyrBAjXajV5aZAglkqzIayxwYG8t2zvXODwa5ChKfu8pHEkGHggdfsRfZlpBRxuGF5EiAmhpG2JwES0pELs+HSnUNCyA8WZvLuDFzKqDvpmBg2DDm8mTV7kT0CI/FBVtWTADExqxKovOUjifJ4AMp+uHlJTJyunOB7B2Z7fwhYZoRghtXDhiGHL6N2N9LwEkhkQBKyShsnAYkdtLJLPaDGfczRBAsSpYw3PzQDbbE/ucKzkUDuCKJGqKdaV+o0O5F9mUDiGbJsCnQpiWEilYiqvL5EAylpbQAsCC8Vuvph7tE71DMZ4n2gIdaqca6I7UBK+eyanSg/YBjJmhUrdmrjqKur4hPe7jieAEhKU84PANdw+exst/Aduic/+3Gc97EgFB/dr1IPNVuxaYt2J3IKRCLRSDueAEieK6K4K3Zp08GpjgfEGWO50tSjBx/vqu+Gxnio6ze/fZRgIbVEJYaQ6mFbFKe+WrMPxJtEoqpifHBpw2QgSQzbYvXWQEpGwyz/yeOxRxu/fzXY1d//u//6zb7f5yf9gJWuHZHqYVsU4yviaZQExQiLPtKyNZAkhidXmBSjLlB9cakT5sHXbzOl4qONb7/6zd/e/vhkPj/wdIZlK5/H6JMLbOIWwkzQcKHhdamQlJMhdVRA/BsEMhDnAJYtgZQcZQCb+OTCBMOcOnUv7XW73U+77/9hEmZWGp+RcHyvIopUh7uVytQDUsmxKbBWRQzbonFLICX74TY6fH1l5YOJn949+Yeek4//+/pjjyfqk7cvlHrYMJxajVqojrWHhASiRMlGASliZJfWLYCUDKcibGgC8GDl7tLJT0+urvh8K3fdMR8X36smRhiGWfFrOlRloEKSKxl10VcDSH+Dxl26tgLSAsNiw9IKz/M3mPTAKhDu5Kz2tPnkxIpuCxuGA6+yOLemfJlC4kBdvSWQJkZ06dgEqDoegGHR5xeJrSylu1fEy0YXekI++SCOJoYNw25D8UC94Rd9mUYSB3AoBFm0gTQxYtHTACKu6uOBzgQb+eQ6EIhN3ZeIDfh94RF6rqXZx4aBRpJYQ5B11qqQ+Gso1lQD6FAR09ob6QBpORpg+dsf3/DxqxOZ+zcEXuyFNCcHRYO8YkhTbZafjVXyD0SktZLvaCQGWrYCVut0WVu3BZCWjjiATnb4+uqFQObpVdHFPs2w6pPTHSfDOSYCuHB8aWlizP141bey+vh/HoFIfOf9Pq1ShkdSwt3L7MZ7xfv3Tz7uHvBOJWBQ3JkXTGnZ3x4NA9AwMfazT3elJwN+mO4HduIlTA050hpvAHwgA//2caFANDe6c+9x09LUB12NBSASjqXa93TsxNvAetLSmUokDrd2Hmn50zBCQjpy7Tv6v8oR5H8BrdnadapNpUwAAAAASUVORK5CYII=" alt="Logo Karaka" class="h-8 w-auto"/>
        <h1 class="text-xl font-bold">CRM de Llamadas</h1>
        <span class="text-xs pill bg-indigo-100 text-indigo-700">v7.1</span>
      </div>
      <nav class="flex items-center gap-2">
        <button data-view="mapa" class="navbtn active"><i class="fa fa-map"></i> Mapa</button>
        <button data-view="llamada" class="navbtn"><i class="fa fa-phone"></i> Registrar llamada</button>
        <button data-view="asignar" class="navbtn"><i class="fa fa-calendar-week"></i> Asignar semana/día</button>
        <button data-view="reporte" class="navbtn"><i class="fa fa-chart-column"></i> Reporte</button>
        <button id="btnOpenSettings" class="navbtn"><i class="fa fa-gear"></i> Ajustes</button>
      </nav>
    </div>
  </header>

  <!-- Login -->
  <section id="loginSection" class="max-w-md mx-auto mt-10 bg-white p-6 card">
    <h2 class="text-lg font-semibold mb-4"><i class="fa fa-lock"></i> Acceso</h2>
    <form id="loginForm" class="space-y-4">
      <div>
        <label class="block text-sm">Usuario</label>
        <input type="text" id="loginUser" class="w-full p-2 border rounded" required/>
      </div>
      <div>
        <label class="block text-sm">Contraseña</label>
        <input type="password" id="loginPass" class="w-full p-2 border rounded" required/>
      </div>
      <button class="btn bg-blue-600 text-white px-4 py-2 hover:bg-blue-700 w-full">Entrar</button>
      <p class="text-xs text-gray-500">* Validación local contra la hoja <em>Usuarios</em> (CSV publicado).</p>
    </form>
    <div id="loginError" class="mt-3 text-sm text-red-600 hidden"></div>
  </section>

  <!-- App -->
  <main id="appSection" class="hidden">
    <!-- VIEW: MAPA -->
    <section data-view-panel="mapa" class="max-w-7xl mx-auto mt-6 px-4">
      <!-- Botonera -->
      <div class="bg-white p-4 card mb-4">
        <div class="flex flex-wrap gap-3">
          <button id="btnRegistrarLlamada" class="btn bg-blue-600 text-white px-4 py-2 hover:bg-blue-700"><i class="fa fa-phone"></i> Registrar llamada</button>
          <button id="btnAsignarSemana" class="btn bg-yellow-500 text-white px-4 py-2 hover:bg-yellow-600"><i class="fa fa-calendar-week"></i> Asignar semana/día</button>
          <button id="btnRefrescar" class="btn bg-gray-200 px-4 py-2 hover:bg-gray-300"><i class="fa fa-rotate"></i> Refrescar</button>
          <button id="btnExport" class="btn bg-green-600 text-white px-4 py-2 hover:bg-green-700"><i class="fa fa-file-export"></i> Exportar CSV</button>
        </div>
      </div>

      <!-- Mapa -->
      <div class="bg-white p-4 card mb-6">
        <h3 class="text-lg font-semibold mb-3">Mapa de clientes</h3>
        <div id="map" class="w-full h-96 rounded"></div>
        <p class="text-xs text-gray-500 mt-2">* Centrado fijo en República Dominicana.</p>
      </div>

      <!-- Filtros + tabla -->
      <div class="bg-white p-4 card">
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
          <div><label class="block text-sm">Semana</label><select id="fSemana" class="w-full p-2 border rounded"></select></div>
          <div><label class="block text-sm">Día</label><select id="fDia" class="w-full p-2 border rounded"></select></div>
          <div><label class="block text-sm">Vendedor</label><select id="fVendedor" class="w-full p-2 border rounded"></select></div>
          <div><label class="block text-sm">gestor_servicio</label><select id="fGestor" class="w-full p-2 border rounded"></select></div>
          <div><label class="block text-sm">Empresa</label><select id="fEmpresa" class="w-full p-2 border rounded"></select></div>
          <div class="md:col-span-1"></div>
          <div class="md:col-span-6">
            <label class="block text-sm">Buscar cliente</label>
            <input id="fSearch" type="text" class="w-full p-2 border rounded" placeholder="Nombre o Cod Empresa">
          </div>
        </div>

        <div class="mt-6">
          <h3 class="text-lg font-semibold mb-3">Lista de clientes <span class="pill bg-blue-100 text-blue-700" id="badgeTotal">0</span></h3>
          <div class="overflow-x-auto">
            <table id="tablaClientes" class="min-w-full text-sm text-left text-gray-700 border">
              <thead class="bg-gray-50 text-xs uppercase">
                <tr>
                  <th class="px-4 py-2">Cod Empresa</th>
                  <th class="px-4 py-2">Cliente</th>
                  <th class="px-4 py-2">Semana</th>
                  <th class="px-4 py-2">Día</th>
                  <th class="px-4 py-2">Vendedor</th>
                  <th class="px-4 py-2">gestor_servicio</th>
                  <th class="px-4 py-2">Empresa</th>
                  <th class="px-4 py-2">Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- VIEW: REGISTRAR LLAMADA -->
    <section data-view-panel="llamada" class="max-w-4xl mx-auto mt-6 px-4 hidden">
      <div class="bg-white p-6 card">
        <h3 class="text-lg font-semibold mb-4"><i class="fa fa-phone"></i> Registrar llamada</h3>
        <form id="formLlamada" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm">Cliente</label><input list="dl_clientes" id="ll_cliente" class="w-full p-2 border rounded" required><datalist id="dl_clientes"></datalist></div>
          <div><label class="block text-sm">Cod Empresa</label><input id="ll_cod" class="w-full p-2 border rounded" readonly></div>
          <div><label class="block text-sm">Vendedor</label><input id="ll_vendedor" class="w-full p-2 border rounded" readonly></div>
          <div><label class="block text-sm">gestor_servicio</label><input id="ll_gestor" class="w-full p-2 border rounded" readonly></div>
          <div><label class="block text-sm">Fecha y hora</label><input id="ll_fecha" class="w-full p-2 border rounded" readonly></div>
          <div><label class="block text-sm">Resultado</label><select id="ll_resultado" class="w-full p-2 border rounded"><option>Exitosa</option><option>Pendiente</option><option>No contesta</option><option>Cliente no disponible</option></select></div>
          <div><label class="block text-sm">Duración (seg.)</label><input type="number" id="ll_duracion" class="w-full p-2 border rounded" min="0" value="0"></div>
          <div class="md:col-span-2"><label class="block text-sm">Observaciones</label><textarea id="ll_obs" class="w-full p-2 border rounded"></textarea></div>
          <fieldset class="md:col-span-2 border rounded p-3">
            <legend class="text-sm font-semibold">Cita</legend>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-2">
              <div><label class="block text-sm">Tipo</label><select id="ll_cita_tipo" class="w-full p-2 border rounded"><option value="">(sin cita)</option><option>Showroom</option><option>Visita</option></select></div>
              <div><label class="block text-sm">Fecha</label><input type="date" id="ll_cita_fecha" class="w-full p-2 border rounded"></div>
              <div><label class="block text-sm">Hora</label><input type="time" id="ll_cita_hora" class="w-full p-2 border rounded"></div>
            </div>
          </fieldset>
          <div class="md:col-span-2 flex justify-end gap-2 mt-2">
            <button class="btn bg-gray-200 px-4 py-2 hover:bg-gray-300" type="button" data-nav="mapa">Cancelar</button>
            <button class="btn bg-blue-600 text-white px-4 py-2 hover:bg-blue-700" type="submit">Guardar</button>
          </div>
        </form>
      </div>
    </section>

    <!-- VIEW: ASIGNAR -->
    <section data-view-panel="asignar" class="max-w-3xl mx-auto mt-6 px-4 hidden">
      <div class="bg-white p-6 card">
        <h3 class="text-lg font-semibold mb-4"><i class="fa fa-calendar-week"></i> Asignar semana y día</h3>
        <form id="formAsignar" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="md:col-span-2"><label class="block text-sm">Cliente</label><input list="dl_clientes2" id="asig_cliente" class="w-full p-2 border rounded" required><datalist id="dl_clientes2"></datalist></div>
          <div><label class="block text-sm">Semana</label><input type="number" id="asig_semana" class="w-full p-2 border rounded" min="1" max="53" required></div>
          <div><label class="block text-sm">Día</label><select id="asig_dia" class="w-full p-2 border rounded"><option>Lunes</option><option>Martes</option><option>Miércoles</option><option>Jueves</option><option>Viernes</option><option>Sábado</option><option>Domingo</option></select></div>
          <div class="md:col-span-2 flex justify-end gap-2 mt-2">
            <button class="btn bg-gray-200 px-4 py-2 hover:bg-gray-300" type="button" data-nav="mapa">Cancelar</button>
            <button class="btn bg-yellow-600 text-white px-4 py-2 hover:bg-yellow-700" type="submit">Aplicar</button>
          </div>
        </form>
      </div>
    </section>

    <!-- VIEW: REPORTE -->
    <section data-view-panel="reporte" class="max-w-6xl mx-auto mt-6 px-4 hidden">
      <div class="bg-white p-6 card">
        <h3 class="text-lg font-semibold mb-4"><i class="fa fa-chart-column"></i> Reporte de llamadas por gestor</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
          <div><label class="block text-sm">Desde</label><input type="date" id="r_from" class="w-full p-2 border rounded"></div>
          <div><label class="block text-sm">Hasta</label><input type="date" id="r_to" class="w-full p-2 border rounded"></div>
          <div><label class="block text-sm">Gestor</label><select id="r_gestor" class="w-full p-2 border rounded"><option value="">Todos</option></select></div>
          <div class="flex items-end"><button id="r_refresh" class="btn bg-gray-200 px-4 py-2 hover:bg-gray-300 w-full">Actualizar</button></div>
        </div>
        <div class="overflow-x-auto">
          <table id="tablaReporte" class="min-w-full text-sm text-left text-gray-700 border">
            <thead class="bg-gray-50 text-xs uppercase">
              <tr><th class="px-4 py-2">Gestor</th><th class="px-4 py-2">Total</th><th class="px-4 py-2">Exitosas</th><th class="px-4 py-2">Pendientes/No contesta</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Ajustes (modal sencillo) -->
  <div id="settingsModal" class="fixed inset-0 modal-bg hidden items-center justify-center">
    <div class="bg-white p-6 rounded-xl w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold"><i class="fa fa-gear"></i> Ajustes</h3>
        <button id="btnCloseSettings" class="text-gray-600 hover:text-black"><i class="fa fa-xmark text-xl"></i></button>
      </div>
      <p class="text-sm text-gray-600 mb-4">Las URLs CSV ya vienen configuradas. Solo cámbialas si es necesario.</p>
      <label class="block text-sm">URL CSV — Clientes</label><input id="urlClientes" class="w-full p-2 border rounded mb-3">
      <label class="block text-sm">URL CSV — Calendario</label><input id="urlCalendario" class="w-full p-2 border rounded mb-3">
      <label class="block text-sm">URL CSV — Usuarios</label><input id="urlUsuarios" class="w-full p-2 border rounded mb-6">
      <div class="flex items-center justify-end gap-2">
        <button id="btnGuardarSettings" class="btn bg-blue-600 text-white px-4 py-2 hover:bg-blue-700">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG incrustada ======
    const DEFAULT_URLS = { 
      clientes: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1016315198&single=true&output=csv",
      calendario: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv",
      usuarios: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv"
    };
    const KEY_JOIN = "Cod Empresa";
    const COL_SEMANA = "Semana";
    const COL_DIA    = "Dia"; // acepta Dia/Día

    // ====== Estado ======
    let STATE = { urls: DEFAULT_URLS, user:null, data:{clientes:[], calendario:[], usuarios:[]}, joined:[], llamadas:[] };

    // ====== Utilidades ======
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const norm = s => (s??"").toString().replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim().toLowerCase();
    const esc  = s => (s==null?"":String(s));
    const todayISO = () => new Date().toISOString().slice(0,16).replace('T',' ');

    function toast(m){ alert(m); }

    // ====== Navegación de vistas ======
    function goto(view){
      qsa('[data-view]').forEach(b=> b.classList.toggle('active', b.getAttribute('data-view')===view));
      qsa('[data-view-panel]').forEach(p=> p.classList.toggle('hidden', p.getAttribute('data-view-panel')!==view));
      if(view==='mapa'){ renderMap(); renderTable(); }
      if(view==='reporte'){ renderReporte(); }
    }
    qsa('[data-view]').forEach(btn=> btn.addEventListener('click', ()=> goto(btn.getAttribute('data-view'))));
    document.addEventListener('click', e=>{
      const n = e.target.closest('[data-nav]'); if(n) goto(n.getAttribute('data-nav'));
    });
    qs('#btnRegistrarLlamada').addEventListener('click', ()=> goto('llamada'));
    qs('#btnAsignarSemana').addEventListener('click', ()=> goto('asignar'));

    // ====== CSV loader ======
    function fetchCSV(url){
      return new Promise((resolve, reject)=>{
        Papa.parse(url, { header:true, download:true, skipEmptyLines:true,
          complete: res=> resolve(res.data), error: err=> reject(err) });
      });
    }
    async function loadAll(){
      const [clientes, calendario, usuarios] = await Promise.all([
        fetchCSV(STATE.urls.clientes),
        fetchCSV(STATE.urls.calendario),
        fetchCSV(STATE.urls.usuarios),
      ]);
      STATE.data.clientes = clientes.map(nrm);
      STATE.data.calendario = calendario.map(nrm);
      STATE.data.usuarios = usuarios.map(nrm);
      buildJoined();
      renderFilters();
      renderMap();
      renderTable();
      fillDatalists();
    }
    function nrm(row){
      const o = {}; for(const k in row){ o[k]=row[k]; o[k.trim()]=row[k]; }
      return o;
    }

    // ====== Join Clientes + Calendario ======
    function buildJoined(){
      const idxCal = {};
      function getDia(r){ return r[COL_DIA] ?? r['Día'] ?? r['dia'] ?? r['DIA']; }
      function getSem(r){ return r[COL_SEMANA] ?? r['SEMANA'] ?? r['semana']; }

      STATE.data.calendario.forEach(r=>{
        const key = norm(r[KEY_JOIN]);
        if(!key) return;
        if(!(key in idxCal)) idxCal[key] = r;
      });

      STATE.joined = STATE.data.clientes.map(c=>{
        const key = norm(c[KEY_JOIN]);
        const m = idxCal[key];
        const semana = m ? (getSem(m)||'Por asignar') : 'Por asignar';
        const dia    = m ? (getDia(m)||'Por asignar') : 'Por asignar';
        return {
          cod: c[KEY_JOIN] || '',
          nombre: c['NombreCliente'] || c['Cliente'] || c['RazonSocial'] || '',
          lat: parseFloat(c['Latitud']||c['latitud']||c['LATITUD']||''),
          lon: parseFloat(c['Longitud']||c['longitud']||c['LONGITUD']||''),
          semana, dia,
          vendedor: c['Vendedor'] || c['VENDEDOR'] || '',
          gestor: c['gestor_servicio'] || c['GESTOR_SERVICIO'] || c['Gestor'] || '',
          empresa: c['Empresa'] || c['EMPRESA'] || ''
        };
      });
    }

    // ====== Login ======
    qs('#loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const u = norm(qs('#loginUser').value);
      const p = qs('#loginPass').value;
      try{
        if(STATE.data.usuarios.length===0) await loadAll();
        const row = STATE.data.usuarios.find(r=> norm(r['Usuario']||r['NombreUsuario']||r['Login']||r['gestor_servicio'])===u );
        if(!row) throw new Error('Usuario no encontrado');
        const pass = (row['Contrasena']||row['Contraseña']||row['Password']||'').toString();
        if(pass && pass!==p) throw new Error('Contraseña inválida');
        STATE.user = { nombre: row['Usuario']||row['NombreUsuario']||row['gestor_servicio']||u, rol: row['Permiso']||row['Rol']||'usuario' };
        qs('#loginSection').classList.add('hidden');
        qs('#appSection').classList.remove('hidden');
        fillReporteGestores();
        goto('mapa');
      }catch(err){
        qs('#loginError').textContent = '⚠️ ' + err.message;
        qs('#loginError').classList.remove('hidden');
      }
    });

    // ====== Filtros ======
    function uniq(arr){ return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=> String(a).localeCompare(String(b))); }
    function renderFilters(){
      setOptions(qs('#fSemana'), ['','Por asignar', ...uniq(STATE.joined.map(r=>r.semana).filter(v=>v!=='Por asignar'))]);
      const dias = uniq(STATE.joined.map(r=> r.dia || 'Por asignar'));
      setOptions(qs('#fDia'), ['','Por asignar', ...dias.filter(v=>v!=='Por asignar')]);
      setOptions(qs('#fVendedor'), [''].concat(uniq(STATE.joined.map(r=> r.vendedor))));
      setOptions(qs('#fGestor'), [''].concat(uniq(STATE.joined.map(r=> r.gestor))));
      setOptions(qs('#fEmpresa'), [''].concat(uniq(STATE.joined.map(r=> r.empresa))));
      qsa('#fSemana,#fDia,#fVendedor,#fGestor,#fEmpresa').forEach(el=> el.addEventListener('change', ()=>{ renderMap(); renderTable(); }));
      qs('#fSearch').addEventListener('input', ()=>{ renderMap(); renderTable(); });
    }
    function setOptions(sel, arr){
      sel.innerHTML=''; arr.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent= v===''?'Todos':v; sel.appendChild(o); });
    }

    function getFiltered(){
      const fSem = qs('#fSemana').value;
      const fDia = qs('#fDia').value.toLowerCase();
      const fVend = qs('#fVendedor').value;
      const fGest = qs('#fGestor').value;
      const fEmp = qs('#fEmpresa').value;
      const q = qs('#fSearch').value.trim().toLowerCase();
      return STATE.joined.filter(r=>{
        const okSem = !fSem || String(r.semana)===fSem;
        const okDia = !fDia || String(r.dia).toLowerCase()===fDia;
        const okV = !fVend || r.vendedor===fVend;
        const okG = !fGest || r.gestor===fGest;
        const okE = !fEmp || r.empresa===fEmp;
        const okQ = !q || norm(r.cod).includes(q) || norm(r.nombre).includes(q);
        return okSem && okDia && okV && okG && okE && okQ;
      });
    }

    // ====== Tabla ======
    function renderTable(){
      const tbody = qs('#tablaClientes tbody'); tbody.innerHTML='';
      const rows = getFiltered();
      qs('#badgeTotal').textContent = rows.length;
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = '<td class="px-4 py-2">'+esc(r.cod)+'</td>' +
                        '<td class="px-4 py-2">'+esc(r.nombre)+'</td>' +
                        '<td class="px-4 py-2">'+esc(r.semana)+'</td>' +
                        '<td class="px-4 py-2">'+esc(r.dia)+'</td>' +
                        '<td class="px-4 py-2">'+esc(r.vendedor)+'</td>' +
                        '<td class="px-4 py-2">'+esc(r.gestor)+'</td>' +
                        '<td class="px-4 py-2">'+esc(r.empresa)+'</td>' +
                        '<td class="px-4 py-2"><button class="btn bg-blue-600 text-white px-3 py-1 hover:bg-blue-700" data-cod="'+esc(r.cod)+'">Visitar</button></td>';
        tbody.appendChild(tr);
      });
    }

    // ====== Export ======
    qs('#btnExport').addEventListener('click', ()=>{
      const headers = ['Cod Empresa','Cliente','Semana','Dia','Vendedor','gestor_servicio','Empresa'];
      const rows = getFiltered().map(r=> [r.cod,r.nombre,r.semana,r.dia,r.vendedor,r.gestor,r.empresa]);
      const csv = [headers.join(','), ...rows.map(r=> r.map(x=> '\"'+(x??'').toString().replace(/\"/g,'\"\"')+'\"').join(','))].join('\\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='clientes_filtrados.csv'; a.click(); URL.revokeObjectURL(url);
    });
    qs('#btnRefrescar').addEventListener('click', ()=> loadAll());

    // ====== Mapa ======
    let map, markers=[];
    function renderMap(){
      if(!map){
        map = L.map('map').setView([18.7357,-70.1627], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
      } else {
        map.setView([18.7357,-70.1627],8);
      }
      markers.forEach(m=>m.remove()); markers=[];
      const filtered = getFiltered().filter(r=> !isNaN(r.lat) && !isNaN(r.lon));
      filtered.forEach(r=>{
        const m = L.marker([r.lat,r.lon]).addTo(map);
        m.bindPopup('<strong>'+esc(r.nombre)+'</strong><br><small>'+esc(r.cod)+'</small><br>Semana: '+esc(r.semana)+'<br>Día: '+esc(r.dia)+'<br><a href="https://www.google.com/maps/dir/?api=1&destination='+r.lat+','+r.lon+'" target="_blank">Ir con Google Maps</a>');
        markers.push(m);
      });
    }

    // ====== Datalists y helpers ======
    function fillDatalists(){
      const dl1 = qs('#dl_clientes'), dl2 = qs('#dl_clientes2');
      dl1.innerHTML=''; dl2.innerHTML='';
      STATE.joined.forEach(r=>{
        const v = r.nombre+' — '+r.cod;
        const o1=document.createElement('option'); o1.value=v; dl1.appendChild(o1);
        const o2=document.createElement('option'); o2.value=v; dl2.appendChild(o2);
      });
      fillReporteGestores();
      qs('#ll_fecha').value = todayISO();
    }

    // ====== Registrar llamada ======
    qs('#formLlamada').addEventListener('input', (e)=>{
      if(e.target.id==='ll_cliente'){
        const txt = e.target.value; const cod = txt.split('—').pop().trim();
        const r = STATE.joined.find(x=> x.cod===cod);
        if(r){ qs('#ll_cod').value = r.cod; qs('#ll_vendedor').value = r.vendedor; qs('#ll_gestor').value = r.gestor; }
      }
    });
    qs('#formLlamada').addEventListener('submit', (e)=>{
      e.preventDefault();
      const payload = { 
        FechaHora: todayISO(),
        Cliente: qs('#ll_cliente').value,
        CodEmpresa: qs('#ll_cod').value,
        Vendedor: qs('#ll_vendedor').value,
        Gestor: qs('#ll_gestor').value,
        Resultado: qs('#ll_resultado').value,
        Duracion: Number(qs('#ll_duracion').value||0),
        Observaciones: qs('#ll_obs').value,
        CitaTipo: qs('#ll_cita_tipo').value,
        CitaFecha: qs('#ll_cita_fecha').value,
        CitaHora: qs('#ll_cita_hora').value
      };
      STATE.llamadas.push(payload);
      localStorage.setItem('llamadas', JSON.stringify(STATE.llamadas));
      alert('✅ Llamada registrada (local).');
      e.target.reset(); goto('mapa');
    });

    // ====== Asignar semana/día ======
    qs('#formAsignar').addEventListener('submit', (e)=>{
      e.preventDefault();
      const txt = qs('#asig_cliente').value; const cod = txt.split('—').pop().trim();
      const semana = qs('#asig_semana').value; const dia = qs('#asig_dia').value;
      const idx = STATE.joined.findIndex(r=> r.cod===cod);
      if(idx>=0){ STATE.joined[idx].semana = semana; STATE.joined[idx].dia = dia; renderMap(); renderTable(); alert('✅ Asignación aplicada (local).'); goto('mapa'); }
      else alert('No se encontró el cliente seleccionado.');
    });

    // ====== Reporte ======
    function fillReporteGestores(){
      const sel = qs('#r_gestor'); if(!sel) return;
      const vals = uniq(STATE.joined.map(r=> r.gestor));
      sel.innerHTML = '<option value=\"\">Todos</option>' + vals.map(v=> '<option>'+v+'</option>').join('');
    }
    function renderReporte(){
      const data = JSON.parse(localStorage.getItem('llamadas')||'[]');
      STATE.llamadas = data;
      const from = qs('#r_from').value ? new Date(qs('#r_from').value) : null;
      const to = qs('#r_to').value ? new Date(qs('#r_to').value + 'T23:59:59') : null;
      const gestor = qs('#r_gestor').value;
      const rows = data.filter(r=>{
        const d = new Date(r.FechaHora.replace(' ','T'));
        const okF = !from || d>=from; const okT = !to || d<=to; const okG = !gestor || r.Gestor===gestor;
        return okF && okT && okG;
      });
      const grouped = {};
      rows.forEach(r=>{ const g=r.Gestor||'Sin gestor'; if(!grouped[g]) grouped[g]={total:0, ok:0, pend:0}; grouped[g].total++; if(r.Resultado==='Exitosa') grouped[g].ok++; else grouped[g].pend++; });
      const tbody = qs('#tablaReporte tbody'); tbody.innerHTML='';
      Object.keys(grouped).forEach(g=>{ const x=grouped[g]; const tr=document.createElement('tr'); tr.className='border-b'; tr.innerHTML='<td class="px-4 py-2">'+g+'</td><td class="px-4 py-2">'+x.total+'</td><td class="px-4 py-2">'+x.ok+'</td><td class="px-4 py-2">'+x.pend+'</td>'; tbody.appendChild(tr); });
    }
    qs('#r_refresh').addEventListener('click', ()=> renderReporte());

    // ====== Ajustes ======
    const settingsModal = qs('#settingsModal');
    qs('#btnOpenSettings').addEventListener('click', ()=>{ 
      qs('#urlClientes').value = STATE.urls.clientes; 
      qs('#urlCalendario').value = STATE.urls.calendario; 
      qs('#urlUsuarios').value = STATE.urls.usuarios; 
      settingsModal.classList.remove('hidden'); settingsModal.classList.add('flex');
    });
    qs('#btnCloseSettings').addEventListener('click', ()=> settingsModal.classList.add('hidden'));
    qs('#btnGuardarSettings').addEventListener('click', ()=>{
      STATE.urls.clientes = qs('#urlClientes').value || DEFAULT_URLS.clientes;
      STATE.urls.calendario = qs('#urlCalendario').value || DEFAULT_URLS.calendario;
      STATE.urls.usuarios = qs('#urlUsuarios').value || DEFAULT_URLS.usuarios;
      alert('✅ Ajustes guardados en memoria (sesión).');
      settingsModal.classList.add('hidden');
      loadAll();
    });

    // ====== Inicio ======
    window.addEventListener('load', async ()=>{ 
      // Carga preliminar de usuarios para permitir login inmediato
      try { 
        const usuarios = await fetchCSV(STATE.urls.usuarios); 
        STATE.data.usuarios = usuarios.map(nrm);
      } catch(e) {}
    });
  </script>
</body>
</html>
